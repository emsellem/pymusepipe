<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pymusepipe.util_image &mdash; pymusepipe 2.19.9 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> pymusepipe
          </a>
              <div class="version">
                2.19.9
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../welcome.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alignment.html">Alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mosaicking.html">Mosaicking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../convolution.html">Convolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../phangs_example.html">PHANGS pipeline example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">Module Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pymusepipe</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pymusepipe.util_image</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pymusepipe.util_image</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Utility functions for images in pymusepipe</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__authors__</span> <span class="o">=</span> <span class="s2">&quot;Eric Emsellem&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;(c) 2017, ESO + CRAL&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;MIT License&quot;</span>
<span class="n">__contact__</span> <span class="o">=</span> <span class="s2">&quot; &lt;eric.emsellem@eso.org&gt;&quot;</span>

<span class="c1"># Importing modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">joinpath</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="c1"># Numpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.odr</span> <span class="kn">import</span> <span class="n">ODR</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">RealData</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">nd</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> <span class="k">as</span> <span class="n">pyfits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">QTable</span><span class="p">,</span> <span class="n">Column</span>

<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">mad_std</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">sigma_clipped_stats</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Gaussian2DKernel</span><span class="p">,</span> <span class="n">convolve</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">concatenate</span> <span class="k">as</span> <span class="n">concat_skycoords</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>

<span class="c1"># Import package modules</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util_pipe</span> <span class="k">as</span> <span class="n">upipe</span>
<span class="kn">from</span> <span class="nn">.util_pipe</span> <span class="kn">import</span> <span class="n">get_dataset_tpl_nexpo</span>
<span class="kn">from</span> <span class="nn">.config_pipe</span> <span class="kn">import</span> <span class="p">(</span><span class="n">default_ndigits</span><span class="p">,</span> <span class="n">default_str_dataset</span><span class="p">,</span> <span class="n">default_offset_table</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.config_pipe</span> <span class="kn">import</span> <span class="n">mjd_names</span><span class="p">,</span> <span class="n">date_names</span><span class="p">,</span> <span class="n">tpl_names</span><span class="p">,</span> <span class="n">iexpo_names</span><span class="p">,</span> <span class="n">dataset_names</span>
<span class="kn">from</span> <span class="nn">.mpdaf_pipe</span> <span class="kn">import</span> <span class="n">get_centre_from_pixtable</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">photutils.detection</span> <span class="kn">import</span> <span class="n">IRAFStarFinder</span>
    <span class="n">_photutils</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;The python packages photutils is not available. &quot;</span>
                        <span class="s2">&quot;If you wish to use star masking. Please install it.&quot;</span><span class="p">)</span>
    <span class="n">_photutils</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="select_spaxels"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.select_spaxels">[docs]</a><span class="k">def</span> <span class="nf">select_spaxels</span><span class="p">(</span><span class="n">maskdict</span><span class="p">,</span> <span class="n">maskname</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Selecting spaxels defined by their coordinates</span>
<span class="sd">    using the masks defined by Circle or Rectangle Zones</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># All spaxels are set to GOOD (True) first</span>
    <span class="n">selgood</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># If no Mask is provided, we just return the full set of input X, Y</span>
    <span class="k">if</span> <span class="n">maskdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">selgood</span>

    <span class="c1"># We first check if the maskName is in the list of the defined Masks</span>
    <span class="c1"># If the galaxy is not in the list, then the selection is all True</span>
    <span class="k">if</span> <span class="n">maskname</span> <span class="ow">in</span> <span class="n">maskdict</span><span class="p">:</span>
        <span class="c1"># The mask is defined, so Get the list of Regions</span>
        <span class="c1"># From the defined dictionary</span>
        <span class="n">listregions</span> <span class="o">=</span> <span class="n">maskdict</span><span class="p">[</span><span class="n">maskname</span><span class="p">]</span>
        <span class="c1"># For each region, select the good spaxels</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">listregions</span><span class="p">:</span>
            <span class="n">selgood</span> <span class="o">=</span> <span class="n">selgood</span> <span class="o">&amp;</span> <span class="n">region</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">selgood</span></div>


<div class="viewcode-block" id="Selection_Zone"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.Selection_Zone">[docs]</a><span class="k">class</span> <span class="nc">Selection_Zone</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parent class for Rectangle_Zone and Circle_Zone</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    params: list of floats</span>
<span class="sd">        List of parameters for the selection zone</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Warning: no parameters given for Selection Zone&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Rectangle_Zone"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.Rectangle_Zone">[docs]</a><span class="k">class</span> <span class="nc">Rectangle_Zone</span><span class="p">(</span><span class="n">Selection_Zone</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define a rectangular zone, given by</span>
<span class="sd">    a center, a length, a width and an angle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="s2">&quot;Rectangle&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">Selection_Zone</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Rectangle_Zone.select"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.Rectangle_Zone.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xin</span><span class="p">,</span> <span class="n">yin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Define a selection within a rectangle</span>
<span class="sd">            It can be rotated by an angle theta (in degrees)</span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        xin, yin: 2d arrays</span>
<span class="sd">            Input positions for the spaxels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xin</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">theta</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">xin</span> <span class="o">-</span> <span class="n">x0</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">yin</span> <span class="o">-</span> <span class="n">y0</span>
        <span class="n">thetarad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetarad</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetarad</span><span class="p">)</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="o">-</span><span class="n">dx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thetarad</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thetarad</span><span class="p">)</span>
        <span class="n">selgood</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">length</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selgood</span></div></div>


<div class="viewcode-block" id="Circle_Zone"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.Circle_Zone">[docs]</a><span class="k">class</span> <span class="nc">Circle_Zone</span><span class="p">(</span><span class="n">Selection_Zone</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define a Circular zone, defined by</span>
<span class="sd">    a center and a radius</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="s2">&quot;Circle&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">Selection_Zone</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Circle_Zone.select"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.Circle_Zone.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xin</span><span class="p">,</span> <span class="n">yin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Define a selection within a circle</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        xin, yin: 2d arrays</span>
<span class="sd">            Input positions for the spaxels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xin</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">radius</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">selgood</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xin</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yin</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radius</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selgood</span></div></div>


<div class="viewcode-block" id="Trail_Zone"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.Trail_Zone">[docs]</a><span class="k">class</span> <span class="nc">Trail_Zone</span><span class="p">(</span><span class="n">Selection_Zone</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define a Trail zone, defined by</span>
<span class="sd">    two points and a width</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="s2">&quot;Trail&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparams</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">Selection_Zone</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Trail_Zone.select"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.Trail_Zone.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xin</span><span class="p">,</span> <span class="n">yin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Define a selection within trail</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        xin, yin: 2d arrays</span>
<span class="sd">            Input positions for the spaxels</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xin</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">radius</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">selgood</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xin</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yin</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radius</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selgood</span></div></div>


<div class="viewcode-block" id="my_linear_model"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.my_linear_model">[docs]</a><span class="k">def</span> <span class="nf">my_linear_model</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Linear function for the regression.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    b : 1D np.array of 2 floats</span>
<span class="sd">        Input 1D polynomial parameters (0=constant, 1=slope)</span>
<span class="sd">    x : np.array</span>
<span class="sd">        Array which will be multiplied by the polynomial</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        An array = b[1] * (x + b[0])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_polynorm"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.get_polynorm">[docs]</a><span class="k">def</span> <span class="nf">get_polynorm</span><span class="p">(</span><span class="n">array1</span><span class="p">,</span> <span class="n">array2</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">threshold1</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                 <span class="n">threshold2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">),</span> <span class="n">sigclip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the normalisation factor between two arrays.</span>

<span class="sd">    Including the background and slope. This uses the function</span>
<span class="sd">    regress_odr which is included in align_pipe.py and itself</span>
<span class="sd">    makes use of ODR in scipy.odr.ODR.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array1 : 2D np.array</span>
<span class="sd">    array2 : 2D np.array</span>
<span class="sd">        2 arrays (2D) of identical shapes</span>
<span class="sd">    chunk_size : int</span>
<span class="sd">        Default value = 15</span>
<span class="sd">    threshold1 : float</span>
<span class="sd">        Lower threshold for array1 (Default value = 0.)</span>
<span class="sd">    threshold2 : float</span>
<span class="sd">        Lower threshold for array2 (Default value = 0)</span>
<span class="sd">    percentiles : list of 2 floats</span>
<span class="sd">        Percentiles (Default value = [0., 100.])</span>
<span class="sd">    sigclip : float</span>
<span class="sd">        Sigma clipping factor (Default value = 0)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result: python structure</span>
<span class="sd">        Result of the regression (ODR)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># proceeds by splitting the data arrays in chunks of chunk_size</span>
    <span class="n">med</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">chunk_stats</span><span class="p">([</span><span class="n">array1</span><span class="p">,</span> <span class="n">array2</span><span class="p">],</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

    <span class="c1"># Selecting where data is supposed to be good</span>
    <span class="k">if</span> <span class="n">threshold1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threshold1</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">threshold2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threshold2</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">med</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">std</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">std</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">med</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold2</span><span class="p">)</span>
    <span class="c1"># Guess the slope from this selection</span>
    <span class="n">guess_slope</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># Doing the regression itself</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">regress_odr</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">med</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">pos</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">med</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">pos</span><span class="p">],</span> <span class="n">sx</span><span class="o">=</span><span class="n">std</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">pos</span><span class="p">],</span>
                         <span class="n">sy</span><span class="o">=</span><span class="n">std</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">pos</span><span class="p">],</span> <span class="n">beta0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">guess_slope</span><span class="p">],</span>
                         <span class="n">percentiles</span><span class="o">=</span><span class="n">percentiles</span><span class="p">,</span> <span class="n">sigclip</span><span class="o">=</span><span class="n">sigclip</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">med</span> <span class="o">=</span> <span class="n">med</span>
    <span class="n">result</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">std</span>
    <span class="n">result</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">pos</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="regress_odr"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.regress_odr">[docs]</a><span class="k">def</span> <span class="nf">regress_odr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">beta0</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
                <span class="n">percentiles</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">),</span> <span class="n">sigclip</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an ODR linear regression using scipy.odr.ODR</span>

<span class="sd">    Args:</span>
<span class="sd">        x : numpy.array</span>
<span class="sd">        y : numpy.array</span>
<span class="sd">            Input array with signal</span>
<span class="sd">        sx : numpy.array</span>
<span class="sd">        sy : numpy.array</span>
<span class="sd">            Input array (as x,y) with standard deviations</span>
<span class="sd">        beta0 : list or tuple of 2 floats</span>
<span class="sd">            Initial guess for the constant and slope</span>
<span class="sd">        percentiles: tuple or list of 2 floats</span>
<span class="sd">            Two numbers providing the min and max percentiles</span>
<span class="sd">        sigclip: float</span>
<span class="sd">            sigma factor for sigma clipping. If 0, no sigma clipping</span>
<span class="sd">            is performed</span>

<span class="sd">    Returns:</span>
<span class="sd">        result: result of the ODR analysis</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Percentiles</span>
    <span class="n">xrav</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xrav</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">xrav</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">xrav</span> <span class="o">&gt;=</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xrav</span> <span class="o">&lt;=</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xrav</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">xsel</span><span class="p">,</span> <span class="n">ysel</span> <span class="o">=</span> <span class="n">xrav</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">sel</span><span class="p">]</span>
    <span class="n">sxsel</span><span class="p">,</span> <span class="n">sysel</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">sel</span><span class="p">],</span> <span class="n">sy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">sel</span><span class="p">]</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">my_linear_model</span><span class="p">)</span>

    <span class="c1"># We introduce the minimum of x to avoid negative values</span>
    <span class="n">minx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xsel</span><span class="p">)</span>
    <span class="n">mydata</span> <span class="o">=</span> <span class="n">RealData</span><span class="p">(</span><span class="n">xsel</span> <span class="o">-</span> <span class="n">minx</span><span class="p">,</span> <span class="n">ysel</span><span class="p">,</span> <span class="n">sx</span><span class="o">=</span><span class="n">sxsel</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="n">sysel</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ODR</span><span class="p">(</span><span class="n">mydata</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">beta0</span><span class="o">=</span><span class="n">beta0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sigclip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">ysel</span> <span class="o">-</span> <span class="n">my_linear_model</span><span class="p">([</span><span class="n">result</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">result</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">xsel</span><span class="p">)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigclip</span><span class="p">)</span>
        <span class="n">xnsel</span><span class="p">,</span> <span class="n">ynsel</span> <span class="o">=</span> <span class="n">xsel</span><span class="p">[</span><span class="o">~</span><span class="n">filtered</span><span class="o">.</span><span class="n">mask</span><span class="p">],</span> <span class="n">ysel</span><span class="p">[</span><span class="o">~</span><span class="n">filtered</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">sxnsel</span><span class="p">,</span> <span class="n">synsel</span> <span class="o">=</span> <span class="n">sxsel</span><span class="p">[</span><span class="o">~</span><span class="n">filtered</span><span class="o">.</span><span class="n">mask</span><span class="p">],</span> <span class="n">sysel</span><span class="p">[</span><span class="o">~</span><span class="n">filtered</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">clipdata</span> <span class="o">=</span> <span class="n">RealData</span><span class="p">(</span><span class="n">xnsel</span><span class="p">,</span> <span class="n">ynsel</span><span class="p">,</span> <span class="n">sx</span><span class="o">=</span><span class="n">sxnsel</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="n">synsel</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ODR</span><span class="p">(</span><span class="n">clipdata</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">beta0</span><span class="o">=</span><span class="n">beta0</span><span class="p">)</span>

    <span class="c1"># Running the ODR</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="c1"># Offset from the min of x</span>
    <span class="n">r</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">minx</span>

    <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="chunk_stats"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.chunk_stats">[docs]</a><span class="k">def</span> <span class="nf">chunk_stats</span><span class="p">(</span><span class="n">list_arrays</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cut the datasets in 2d chunks and take the median</span>
<span class="sd">    Return the set of medians for all chunks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    list_arrays : list of np.arrays</span>
<span class="sd">        List of arrays with the same sizes/shapes</span>
<span class="sd">    chunk_size : int</span>
<span class="sd">        number of pixel (one D of a 2D chunk)</span>
<span class="sd">        of the chunk to consider (Default value = 15)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    median, standard: 2 arrays of the medians and standard deviations</span>
<span class="sd">        for the given datasets analysed in chunks.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">narrays</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_arrays</span><span class="p">)</span>

    <span class="n">nchunk_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">list_arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">nchunk_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">list_arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Check that all arrays have the same size</span>
    <span class="n">med_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">narrays</span><span class="p">,</span> <span class="n">nchunk_x</span> <span class="o">*</span> <span class="n">nchunk_y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">std_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">med_array</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">list_arrays</span><span class="p">]):</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Datasets are not of the same &quot;</span>
                          <span class="s2">&quot;size in median_compare&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchunk_x</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchunk_y</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">narrays</span><span class="p">):</span>
                    <span class="c1"># Taking the median of all arrays</span>
                    <span class="n">med_array</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">nchunk_y</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span>
                        <span class="n">list_arrays</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">,</span>
                        <span class="n">j</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">:(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">])</span>
                    <span class="c1"># Taking the std deviation of all arrays</span>
                    <span class="n">std_array</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">nchunk_y</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mad_std</span><span class="p">(</span>
                        <span class="n">list_arrays</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">,</span>
                        <span class="n">j</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">:(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">],</span> <span class="n">ignore_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Cleaning in case of Nan</span>
    <span class="n">med_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">med_array</span><span class="p">)</span>
    <span class="n">std_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">std_array</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">med_array</span><span class="p">,</span> <span class="n">std_array</span></div>


<div class="viewcode-block" id="get_flux_range"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.get_flux_range">[docs]</a><span class="k">def</span> <span class="nf">get_flux_range</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">98</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the range of fluxes within the array</span>
<span class="sd">    by looking at percentiles.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    data: 2d array</span>
<span class="sd">        Input array with signal to process</span>
<span class="sd">    low, high: two floats (10, 99)</span>
<span class="sd">        Percentiles to consider to filter</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lperc, hperc: 2 floats</span>
<span class="sd">        Low and high percentiles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Omit the border pixels</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>

    <span class="c1"># Clean up the NaNs</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lperc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">low</span><span class="p">)</span>
        <span class="n">hperc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">high</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lperc</span><span class="p">,</span> <span class="n">hperc</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span>

    <span class="k">return</span> <span class="n">lperc</span><span class="p">,</span> <span class="n">hperc</span></div>


<div class="viewcode-block" id="get_normfactor"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.get_normfactor">[docs]</a><span class="k">def</span> <span class="nf">get_normfactor</span><span class="p">(</span><span class="n">array1</span><span class="p">,</span> <span class="n">array2</span><span class="p">,</span> <span class="n">median_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">convolve_data1</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">convolve_data2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                   <span class="n">threshold</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the normalisation factor for shifted and projected images. This function</span>
<span class="sd">    only consider the input images given by their data (numpy) arrays.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    array1: 2d np.array</span>
<span class="sd">    array2: 2d np.array</span>
<span class="sd">        Input arrays. Should be the same size</span>
<span class="sd">    median_filter: bool</span>
<span class="sd">        If True, will median filter</span>
<span class="sd">    convolve_muse: float [0]</span>
<span class="sd">        Will convolve the image with index nima</span>
<span class="sd">        with a gaussian with that sigma. 0 means no convolution</span>
<span class="sd">    convolve_reference: float [0]</span>
<span class="sd">        Will convolve the reference image</span>
<span class="sd">        with a gaussian with that sigma. 0 means no convolution</span>
<span class="sd">    border: int</span>
<span class="sd">        Number of pixels to crop</span>
<span class="sd">    threshold: float [None]</span>
<span class="sd">        Threshold for the input image flux to consider</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data: 2d array</span>
<span class="sd">    refdata: 2d array</span>
<span class="sd">        The 2 arrays (input, reference) after processing</span>
<span class="sd">    polypar: the result of an ODR regression</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Retrieving the data and preparing it</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="n">prepare_image</span><span class="p">(</span><span class="n">array1</span><span class="p">,</span> <span class="n">median_filter</span><span class="o">=</span><span class="n">median_filter</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">convolve_data1</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="n">border</span><span class="p">)</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">prepare_image</span><span class="p">(</span><span class="n">array2</span><span class="p">,</span> <span class="n">median_filter</span><span class="o">=</span><span class="n">median_filter</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">convolve_data2</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="n">border</span><span class="p">)</span>
    <span class="n">polypar</span> <span class="o">=</span> <span class="n">get_polynorm</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">threshold1</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>

    <span class="c1"># Returning the processed data</span>
    <span class="k">return</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">polypar</span></div>


<div class="viewcode-block" id="crop_data"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.crop_data">[docs]</a><span class="k">def</span> <span class="nf">crop_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Crop a 2D data and return it cropped after a border</span>
<span class="sd">    has been removed (number of pixels) from each edge</span>
<span class="sd">    (borderx2 pixels are removed from each dimension)</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    data: 2d array</span>
<span class="sd">        Array which has the signal to be cropped</span>
<span class="sd">    border: int</span>
<span class="sd">        Number of pixels to be cropped at each edge</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cdata: 2d array</span>
<span class="sd">        Cropped data array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">border</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Input data to crop is not 2, &quot;</span>
                            <span class="s2">&quot;returning the original data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">border</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">border</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">border</span><span class="p">:</span><span class="o">-</span><span class="n">border</span><span class="p">,</span> <span class="n">border</span><span class="p">:</span><span class="o">-</span><span class="n">border</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Data is not being cropped, as shape is </span><span class="si">{0}</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot; while border is </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">border</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="filtermed_image"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.filtermed_image">[docs]</a><span class="k">def</span> <span class="nf">filtermed_image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepnan</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process image by removing the borders</span>
<span class="sd">    and filtering it via a median filter</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    data: 2d array</span>
<span class="sd">        Array to be processed</span>
<span class="sd">    border: int</span>
<span class="sd">        Number of pixels to remove at each edge</span>
<span class="sd">    filter_size: float</span>
<span class="sd">        Size of the filtering (median)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cdata: 2d array</span>
<span class="sd">        Processed array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Omit the border pixels</span>
    <span class="k">if</span> <span class="n">border</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="n">border</span><span class="p">)</span>

    <span class="c1"># Masking the Nan with 0</span>
    <span class="n">mynan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">meddata</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">median_filter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">filter_size</span><span class="p">)</span>
    <span class="c1"># Putting the Nan back if needed</span>
    <span class="k">if</span> <span class="n">keepnan</span><span class="p">:</span>
        <span class="n">meddata</span><span class="p">[</span><span class="n">mynan</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">meddata</span></div>


<div class="viewcode-block" id="prepare_image"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.prepare_image">[docs]</a><span class="k">def</span> <span class="nf">prepare_image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">median_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Median filter plus convolve the input image</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    data: 2D np.array</span>
<span class="sd">        Data to process</span>
<span class="sd">    median_filter: bool</span>
<span class="sd">        If True, will median filter</span>
<span class="sd">    convolve float [0]</span>
<span class="sd">        Will convolve the data with this gaussian width (sigma)</span>
<span class="sd">        0 means no convolution</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data: 2d array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If median filter do the filtermed_image process including the border</span>
    <span class="c1"># No cropping here</span>
    <span class="k">if</span> <span class="n">median_filter</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">filtermed_image</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Smoothing out the result in case it is needed</span>
    <span class="k">if</span> <span class="n">sigma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">x_stddev</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

    <span class="c1"># Cropping the data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>

    <span class="c1"># Returning the processed data</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="flatclean_image"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.flatclean_image">[docs]</a><span class="k">def</span> <span class="nf">flatclean_image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                  <span class="n">median_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">remove_bkg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process image by squeezing the range, removing</span>
<span class="sd">    the borders and filtering it. The image is first filtered,</span>
<span class="sd">    then it is cropped. All values below a given minimum are</span>
<span class="sd">    set to 0 and all Nan set to 0 or infinity accordingly.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    data: 2d ndarray</span>
<span class="sd">        Input array to process</span>
<span class="sd">    dynamic_range: float [10]</span>
<span class="sd">        Dynamic range used to squash the bright pixels down</span>
<span class="sd">    median_window: int [10]</span>
<span class="sd">        Size of the window used for the median filtering.</span>
<span class="sd">    threshold: float [0]</span>
<span class="sd">        Value of the minimum value allowed.</span>
<span class="sd">    squeeze: bool</span>
<span class="sd">        Squeeze the dynamic range by using the dynamic_range variable</span>
<span class="sd">    crop: bool</span>
<span class="sd">        Crop the borders using border as the variable</span>
<span class="sd">    remove_bkg: remove the filter_medianed background</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flatcleaned_array: 2d ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
        <span class="c1"># Squish bright pixels down</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">data</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">remove_bkg</span><span class="p">:</span>
        <span class="c1"># Remove a median filtered value from the data</span>
        <span class="n">data</span> <span class="o">-=</span> <span class="n">filtermed_image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">median_window</span><span class="p">)</span>

    <span class="c1"># Crop the border</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>

    <span class="c1"># Removing all values below threshold</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Clean up the NaNs</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">cdata</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cdata</span></div>


<div class="viewcode-block" id="mask_point_sources"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.mask_point_sources">[docs]</a><span class="k">def</span> <span class="nf">mask_point_sources</span><span class="p">(</span><span class="n">ima</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mask_radius</span><span class="o">=</span><span class="mf">30.</span><span class="p">,</span> <span class="n">brightest</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find and mask point sources in an image by adding NaN</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    ima: ndarray</span>
<span class="sd">        Image to mask</span>
<span class="sd">    fwhm: float</span>
<span class="sd">        guess for the FWHM in pixel of the PSF. Defaults to 3.</span>
<span class="sd">    mask_radius: float</span>
<span class="sd">        Radius in pixels to mask around sources</span>
<span class="sd">    brightest: int</span>
<span class="sd">        Maximum number of bright stars to mask. Defaults to 5.</span>
<span class="sd">    sigma: float</span>
<span class="sd">        Sigma to clip the image</span>
<span class="sd">    verbose: bool</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ima: np.array</span>
<span class="sd">        with NaN where the mask applied</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_photutils</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: photutils is not available - no option to detect and mask stars&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ima</span>

    <span class="c1"># Define a threshold to look for stars</span>
    <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">ima</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="mf">10.</span> <span class="o">*</span> <span class="n">std</span>

    <span class="c1"># Initializing and starting the starfinder</span>
    <span class="n">starfinder</span> <span class="o">=</span> <span class="n">IRAFStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">,</span> <span class="n">brightest</span><span class="o">=</span><span class="n">brightest</span><span class="p">)</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">starfinder</span><span class="p">(</span><span class="n">ima</span><span class="p">)</span>

    <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">ima</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span> <span class="n">ima</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="n">mima</span> <span class="o">=</span> <span class="n">ima</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># iterate over the identified sources and apply circular masks over them.</span>
    <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span><span class="si">}</span><span class="s1"> detected&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="n">dist_from_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xx</span> <span class="o">-</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                       <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">dist_from_source</span> <span class="o">&lt;</span> <span class="n">mask_radius</span>
            <span class="n">mima</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">mima</span></div>


<div class="viewcode-block" id="create_offset_table"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.create_offset_table">[docs]</a><span class="k">def</span> <span class="nf">create_offset_table</span><span class="p">(</span><span class="n">image_names</span><span class="p">,</span> <span class="n">table_folder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;dummy_offset_table.fits&quot;</span><span class="p">,</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an offset list table from a given set of images. It will use</span>
<span class="sd">    the MJD and DATE as read from the descriptors of the images. The names for</span>
<span class="sd">    these keywords is stored in the dictionary default_offset_table from</span>
<span class="sd">    config_pipe.py</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_names : list of str</span>
<span class="sd">        List of image names to be considered. (Default value = [])</span>
<span class="sd">    table_folder : str</span>
<span class="sd">        folder of the table (Default value = &quot;&quot;)</span>
<span class="sd">    table_name : str</span>
<span class="sd">        name of the table to save [&#39;dummy_offset_table.fits&#39;]</span>
<span class="sd">        (Default value = &quot;dummy_offset_table.fits&quot;)</span>
<span class="sd">    overwrite : bool</span>
<span class="sd">        if the table exists, it will be overwritten if set</span>
<span class="sd">        to True only. (Default value = False)</span>
<span class="sd">    overwrite : bool</span>
<span class="sd">        if the table exists, it will be overwritten if set</span>
<span class="sd">        to True only. (Default value = False)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        A fits table with the output given name. (Default value = False)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if table exists and see if overwrite is set up</span>
    <span class="n">table_fullname</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">table_folder</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">table_fullname</span><span class="p">):</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;[create_offset_table] Table </span><span class="si">{0}</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_fullname</span><span class="p">))</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Use overwrite=True if you wish to proceed&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nimages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;No image names provided for create_offset_table&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Gather the values of DATE and MJD from the images</span>
    <span class="n">date</span><span class="p">,</span> <span class="n">mjd</span><span class="p">,</span> <span class="n">tpls</span><span class="p">,</span> <span class="n">iexpo</span><span class="p">,</span> <span class="n">dataset</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ima</span> <span class="ow">in</span> <span class="n">image_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ima</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;[create_offset] Image </span><span class="si">{0}</span><span class="s2"> does not exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ima</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="n">head</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">ima</span><span class="p">)</span>
        <span class="n">date</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">date_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]])</span>
        <span class="n">mjd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">mjd_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]])</span>
        <span class="n">tpls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">tpl_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]])</span>
        <span class="n">iexpo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">iexpo_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]])</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">dataset_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]])</span>

    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

    <span class="c1"># Create and fill the table</span>
    <span class="n">offset_table</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">default_offset_table</span><span class="p">:</span>
        <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">default</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_offset_table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="n">offset_table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">([</span><span class="n">default</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">)],</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

    <span class="n">offset_table</span><span class="p">[</span><span class="n">date_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">date</span>
    <span class="n">offset_table</span><span class="p">[</span><span class="n">mjd_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mjd</span>
    <span class="n">offset_table</span><span class="p">[</span><span class="n">tpl_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tpls</span>
    <span class="n">offset_table</span><span class="p">[</span><span class="n">iexpo_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iexpo</span>
    <span class="n">offset_table</span><span class="p">[</span><span class="n">dataset_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dataset</span>

    <span class="c1"># Write the table</span>
    <span class="n">offset_table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table_fullname</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>


<div class="viewcode-block" id="group_xy_per_fieldofview"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.group_xy_per_fieldofview">[docs]</a><span class="k">def</span> <span class="nf">group_xy_per_fieldofview</span><span class="p">(</span><span class="n">center_dict</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Group exposures in pointings based on their proximity.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    center_dict: dict</span>
<span class="sd">        Dictionary containing a list of filenames and their coordinates.</span>
<span class="sd">    limit: Quantity default=10*.u.arcsec, optional</span>
<span class="sd">        maximum separation for files to belong to the same pointing. Defaults to 10*u.arcsec.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Dict: [int, list]</span>
<span class="sd">        Dictionary grouping the input files by pointing. The keys of the dictionary are the</span>
<span class="sd">        pointing numbers, and to each pointing a list of filenames is associated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># transform from lists to array, better masking</span>
    <span class="c1"># and concatenate single coordinates in a single SkyCoord object</span>
    <span class="n">allnames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">center_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">allcoords</span> <span class="o">=</span> <span class="n">concat_skycoords</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">center_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="c1"># empty list. Here I will put the lists of files belonging to pointings</span>
    <span class="n">pointing_lists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">files_pointing_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">allcoords</span><span class="p">:</span>
        <span class="c1"># measuring the distance between the center of this file and all the files</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">allcoords</span><span class="p">)</span>

        <span class="c1"># finding all the files closer than the limit</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">limit</span>

        <span class="c1"># saving these files. Transforming each list in tuple to allow set to work later</span>
        <span class="n">selnames</span> <span class="o">=</span> <span class="n">allnames</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">selnames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">pointing_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">selnames</span><span class="p">))</span>

    <span class="c1"># Remove duplicates if any and sort</span>
    <span class="n">pointing_lists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pointing_lists</span><span class="p">))</span>
    <span class="n">pointing_lists</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="c1"># generating output dictionary</span>
    <span class="n">pointing_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">list_files</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pointing_lists</span><span class="p">):</span>
        <span class="n">pointing</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">pointing_dict</span><span class="p">[</span><span class="n">pointing</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">list_files</span><span class="p">)</span>  <span class="c1"># requirements said list</span>
        <span class="c1"># Also a reverse dictionary to have a direct access to the pointing associated with a file</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">list_files</span><span class="p">:</span>
            <span class="n">files_pointing_dict</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">pointing</span>

    <span class="k">return</span> <span class="n">pointing_dict</span><span class="p">,</span> <span class="n">files_pointing_dict</span></div>


<div class="viewcode-block" id="compute_diagnostics"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.compute_diagnostics">[docs]</a><span class="k">def</span> <span class="nf">compute_diagnostics</span><span class="p">(</span><span class="n">pointing_dict</span><span class="p">,</span> <span class="n">center_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the average and std of the distance between the exposures belonging</span>
<span class="sd">    to the same pointing.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    pointing_dict: dict</span>
<span class="sd">        Dictionary for the pointings</span>
<span class="sd">    center_dict: dict</span>
<span class="sd">        dictionary of the files to be used</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Diagnostic: dict</span>
<span class="sd">        Each pointing key has its [mean, std] as value of the distionary</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Creating the containers</span>
    <span class="n">diags</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pointing</span> <span class="ow">in</span> <span class="n">pointing_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># selecting only the interesting files</span>
        <span class="n">selected_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pointing</span><span class="p">:</span>
            <span class="n">selected_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_dict</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="c1"># putting all the other coords in the same SkyCoord object</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">selected_coords</span> <span class="o">=</span> <span class="n">concat_skycoords</span><span class="p">(</span><span class="n">selected_coords</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_coords</span> <span class="o">=</span> <span class="n">selected_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ra_cen</span> <span class="o">=</span> <span class="n">selected_coords</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">dec_cen</span> <span class="o">=</span> <span class="n">selected_coords</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">ref</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra_cen</span><span class="p">,</span> <span class="n">dec_cen</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

        <span class="n">distance</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">selected_coords</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">distance</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">distance</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">diags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">diags</span></div>


<div class="viewcode-block" id="group_exposures_per_pointing"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.group_exposures_per_pointing">[docs]</a><span class="k">def</span> <span class="nf">group_exposures_per_pointing</span><span class="p">(</span><span class="n">list_files</span><span class="p">,</span> <span class="n">target_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Separate a list of files in pointings based on their proximity.</span>

<span class="sd">    This function assign each file to a pointing. Pointings are defined as groups of exposures</span>
<span class="sd">    whose distance between the centers falls within a certain limit. Once the groups of exposures</span>
<span class="sd">    have been defined, they are sorted, and then a pointing number starting from 1 is assigned to</span>
<span class="sd">    all of them. Some info on the average std of the eparation between exposures can be optionally</span>
<span class="sd">    computed.</span>

<span class="sd">    Input</span>
<span class="sd">    ------</span>
<span class="sd">    list_files: list</span>
<span class="sd">        list of files to be reorganized in pointings</span>
<span class="sd">    target_path: str default=&#39;&#39;</span>
<span class="sd">        path of the target files</span>
<span class="sd">    limit: float default=10</span>
<span class="sd">        maximum separation for files to belong to the same pointing</span>
<span class="sd">    unit: astropy unit default=u.arcsec</span>
<span class="sd">        Unit of spatial distance (e.g., astropy.unit.arcsec)</span>
<span class="sd">    ext: int default=1, optional</span>
<span class="sd">        header extension where the WCS information is located.</span>
<span class="sd">    dtype: str default &#39;image&#39;, optional</span>
<span class="sd">        type of file to be analyzed. It can be pixtable, image or cube. Defaults to image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Pointing dictionary: Dict of [int, list]</span>
<span class="sd">        Dictionary grouping the input files by pointing. The keys of the dictionary are the</span>
<span class="sd">        pointing numbers, and to each pointing a list of filenames is associated.</span>
<span class="sd">    Diagnostic dictionary: Dict of [int, list], only if diagnostics</span>
<span class="sd">        Dictionary containing basic information on the distance between exposures belonging to</span>
<span class="sd">        the same pointing. For each pointing, the mean and std of the distance with respect to</span>
<span class="sd">        a reference exposure is reported.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># open all the files and recover the RA and dec informations</span>
    <span class="n">center_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">dict_dtype</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pixtable&#39;</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;cube&#39;</span><span class="p">,</span> <span class="s1">&#39;guess&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_dtype</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s1"> is not a supported data type.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">list_files</span> <span class="p">:</span>
        <span class="c1"># open file and recover the primary header</span>
        <span class="n">fullname</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;guess&quot;</span><span class="p">:</span>
            <span class="n">ldtype</span> <span class="o">=</span> <span class="p">[</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">dict_dtype</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ldtype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not guess type of file </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">thistype</span> <span class="o">=</span> <span class="n">ldtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thistype</span> <span class="o">=</span> <span class="n">dtype</span>

        <span class="k">if</span> <span class="n">thistype</span> <span class="o">==</span> <span class="s1">&#39;pixtable&#39;</span><span class="p">:</span>
            <span class="n">coord_center</span> <span class="o">=</span> <span class="n">get_centre_from_pixtable</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coord_center</span> <span class="o">=</span> <span class="n">get_centre_from_image_or_cube</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># save in a dictionary the file names and the coordinates</span>
        <span class="c1"># Note that we only store the name, not the full name with folder</span>
        <span class="n">center_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord_center</span>

    <span class="n">pointing_dict</span><span class="p">,</span> <span class="n">files_pointing_dict</span> <span class="o">=</span> <span class="n">group_xy_per_fieldofview</span><span class="p">(</span><span class="n">center_dict</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span> <span class="o">*</span> <span class="n">unit</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">center_dict</span><span class="p">,</span> <span class="n">pointing_dict</span><span class="p">,</span> <span class="n">files_pointing_dict</span></div>


<div class="viewcode-block" id="get_centre_from_image_or_cube"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.get_centre_from_image_or_cube">[docs]</a><span class="k">def</span> <span class="nf">get_centre_from_image_or_cube</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the coordinate of the center of the FOV from an image. Only pixels with</span>
<span class="sd">    actual signal are considered.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    file_name: st</span>
<span class="sd">        name of the file to analyse</span>
<span class="sd">    ext: int default=1, optional</span>
<span class="sd">        extension where the data and WCS info are located. Defaults to 1.</span>
<span class="sd">    dtype: str default=&#39;image&#39;, optional</span>
<span class="sd">        type of file to be analyzed. It can be either image or cube. Defaults to image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SkyCoord: astropy.coordinates.SkyCoord</span>
<span class="sd">        Coordinate of the center of the FOV</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># open the file and extract data and header</span>
    <span class="k">with</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="c1"># recover the WCS</span>
    <span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cube&#39;</span><span class="p">:</span>
        <span class="n">nz</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># considering only central slice</span>
        <span class="n">slice_id</span> <span class="o">=</span> <span class="n">nz</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">slice_id</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># selecting only part of the image with signal</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">ny</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="n">nx</span><span class="p">]</span>

    <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1"># computing the barycenter</span>
    <span class="n">xcen</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="n">ycen</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>

    <span class="c1"># from pixels to sky coordinates</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cube&#39;</span><span class="p">:</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">,</span> <span class="n">slice_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">coord</span></div>


<div class="viewcode-block" id="get_pointing_table_from_folder"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.get_pointing_table_from_folder">[docs]</a><span class="k">def</span> <span class="nf">get_pointing_table_from_folder</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s2">&quot;fits&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scan a given folder and look for a set of filenames that could enter a pointing</span>
<span class="sd">    table. Those names are decrypted following a given scheme.</span>

<span class="sd">    Input</span>
<span class="sd">    ------</span>
<span class="sd">    folder: str default=&#39;&#39;</span>
<span class="sd">        Name of the folder to scan</span>
<span class="sd">    prefix: str default=&#39;&#39;</span>
<span class="sd">        Prefix to be used to filter the filenames</span>
<span class="sd">    suffix: str default=&#39;&#39;</span>
<span class="sd">        End of the word before the stem (extension)</span>
<span class="sd">    ext: str default=&#39;fits&#39;</span>
<span class="sd">        Extension</span>

<span class="sd">    Create the self.pointing_table attribute</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First check that the folder exists</span>
    <span class="n">realfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">realfolder</span><span class="p">):</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> does not exist - Aborting folder scan [pointing_table]&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># initialise the table</span>
    <span class="n">column_formats</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;column_formats&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;S50&#39;</span><span class="p">,</span> <span class="s1">&#39;S30&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">))</span>
    <span class="n">pointing_table</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;tpls&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;expo&#39;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">column_formats</span><span class="p">)</span>
    <span class="n">str_dataset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;str_dataset&quot;</span><span class="p">,</span> <span class="n">default_str_dataset</span><span class="p">)</span>
    <span class="n">ndigits</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ndigits&quot;</span><span class="p">,</span> <span class="n">default_ndigits</span><span class="p">)</span>
    <span class="n">filtername</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;filtername&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># List the files in the folder, using the prefix</span>
    <span class="n">this_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span>
    <span class="n">list_existing_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building the pointing table from the list of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_existing_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                     <span class="s2">&quot;files&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">list_existing_files</span><span class="p">:</span>
        <span class="n">fdataset</span><span class="p">,</span> <span class="n">ftpls</span><span class="p">,</span> <span class="n">fexpo</span> <span class="o">=</span> <span class="n">get_dataset_tpl_nexpo</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">str_dataset</span><span class="o">=</span><span class="n">str_dataset</span><span class="p">,</span>
                                                       <span class="n">ndigits</span><span class="o">=</span><span class="n">ndigits</span><span class="p">,</span> <span class="n">filtername</span><span class="o">=</span><span class="n">filtername</span><span class="p">)</span>
        <span class="c1"># Exclude file which didn&#39;t have a proper dataset</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">fdataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pointing_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">((</span><span class="n">filename</span><span class="p">,</span> <span class="n">ftpls</span><span class="p">,</span> <span class="n">fdataset</span><span class="p">,</span> <span class="n">fexpo</span><span class="p">))</span>

    <span class="n">pointing_table</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pointing_table</span></div>


<div class="viewcode-block" id="PointingTable"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.PointingTable">[docs]</a><span class="k">class</span> <span class="nc">PointingTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">list_colnames_ptable</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;tpls&#39;</span><span class="p">,</span> <span class="s1">&#39;expo&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up the Pointing Table which contains information about datasets and</span>
<span class="sd">        pointings. This is initialised by a given filename.</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        tablename: str</span>
<span class="sd">        folder: str</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span> <span class="o">=</span> <span class="n">tablename</span>
        <span class="n">realfolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">realfolder</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> does not exist. Using local folder&quot;</span><span class="p">)</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folderout</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folderout&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">format_read</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guess</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;guess&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Init an empty table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">()</span>

        <span class="c1"># if filename exists is not None we read</span>
        <span class="k">if</span> <span class="n">tablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If path name does not exist abort</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">):</span>
                <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filename </span><span class="si">{</span><span class="n">tablename</span><span class="si">}</span><span class="s2"> does not exist in folder </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">tablename</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format_read</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">guess</span><span class="p">)</span>
        <span class="c1"># else we just scan the folder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_folder</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fulltablename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fullnameout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenameout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tablenameout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tablenameout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablenameout</span>
        <span class="k">return</span> <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folderout</span><span class="p">,</span> <span class="n">tablenameout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pointing_table&#39;</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Object does not have pointing_table attribute&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the pointing table has the right minimum entries. Namely:</span>
<span class="sd">        filename, dataset, tpls, expo, pointing. If pointing does not exist,</span>
<span class="sd">        will create it following the logic : pointing=dataset.</span>
<span class="sd">        Returns boolean: True means it&#39;s all good. False will follow a specific message.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exist</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">colname</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_colnames_ptable</span> <span class="k">if</span> <span class="n">colname</span> <span class="ow">not</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns in input file: </span><span class="si">{</span><span class="n">missing_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="PointingTable.scan_folder"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.PointingTable.scan_folder">[docs]</a>    <span class="k">def</span> <span class="nf">scan_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan a folder to create a full pointing table</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        folder: str default to None</span>
<span class="sd">           If not provided, will use the default self.folder</span>
<span class="sd">        **kwargs:</span>
<span class="sd">            Other keywords are passed to create_pointing_table_from_folder</span>

<span class="sd">        Creates</span>
<span class="sd">        -------</span>
<span class="sd">        Attribute pointing_table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanning folder </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span> <span class="o">=</span> <span class="n">get_pointing_table_from_folder</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_select</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_pointing</span><span class="p">()</span></div>

<div class="viewcode-block" id="PointingTable.write"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.PointingTable.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write out the pointing_table on disk, using the nameout and provided folder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        overwrite: bool default=False</span>
<span class="sd">        **kwargs:</span>
<span class="sd">            Valid keywords are</span>
<span class="sd">            folder: str</span>
<span class="sd">            nameout: str</span>
<span class="sd">            Extra keywords are passed to the astropy QTable.write() function</span>

<span class="sd">        Writes the pointing table on disk</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reading the input</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">nameout</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nameout&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nameout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;No provided output filename&quot;</span><span class="p">)</span>

        <span class="c1"># Writing up using the astropy QTable write</span>
        <span class="n">fullnameout</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">nameout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fullnameout</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_reset_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the select column with 1 by default</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        value: int default=1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If no selection is done, just select all by default</span>
        <span class="k">if</span> <span class="s2">&quot;select&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset_pointing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the pointing column in the pointing table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;pointing&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="o">.</span><span class="n">replace_column</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pointing&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pointing&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="PointingTable.read"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.PointingTable.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the input filename in given folder assuming a given format.</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        filename: str, optional</span>
<span class="sd">            Name of the filename</span>
<span class="sd">        folder: str default=&#39;&#39;, optional</span>
<span class="sd">            Name of the folder where to find the filename</span>
<span class="sd">        format: str default=&#39;ascii&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self.pointing_table with the content of the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">fullname</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_read</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guess</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;guess&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fullname</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pointing Table </span><span class="si">{</span><span class="n">fullname</span><span class="si">}</span><span class="s2"> does not exist. Cannot open&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format_read</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">guess</span><span class="p">,</span>
                                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">():</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Please consider updating the pointing table&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_select</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_pointing</span><span class="p">()</span>

        <span class="c1"># After reading, save the selection to an original one to backup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">[</span><span class="s1">&#39;select_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_centres</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_centres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">center_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the centre of each exposure, assuming a given type</span>

<span class="sd">        Input</span>
<span class="sd">        ------</span>
<span class="sd">        dtype: str</span>
<span class="sd">            Must be &#39;image&#39;, &#39;cube&#39; or &#39;pixeltable&#39;</span>
<span class="sd">        center_dict: dictionary, optional</span>
<span class="sd">            Dictionary including the filenames and their centres</span>
<span class="sd">            If not provided, it will just use the filenames and rederive the centres</span>

<span class="sd">        **kwargs:</span>
<span class="sd">            Additional keywords. Valid ones are</span>
<span class="sd">               ext: int</span>
<span class="sd">                   Number of the extension to look at for thw WCS</span>

<span class="sd">        Add column centre in the pointing_table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;cube&quot;</span><span class="p">,</span> <span class="s2">&quot;pixtable&quot;</span><span class="p">,</span> <span class="s2">&quot;guess&quot;</span><span class="p">]:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dtype </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> not recognised [&#39;image&#39;, &#39;cube&#39;, &#39;pixtable&#39;, &#39;guess&#39;]&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">dict_dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IMAGE&#39;</span><span class="p">:</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;CUBE&#39;</span><span class="p">:</span> <span class="s1">&#39;cube&#39;</span><span class="p">,</span> <span class="s1">&#39;PIXTABLE&#39;</span><span class="p">:</span> <span class="s1">&#39;pixtable&#39;</span><span class="p">}</span>

        <span class="c1"># initialise the centre column</span>
        <span class="k">if</span> <span class="s1">&#39;centre&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">dummycoord</span> <span class="o">=</span> <span class="p">[</span><span class="n">SkyCoord</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">dummycoord</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;centre&quot;</span><span class="p">)</span>

        <span class="c1"># Loop over the pointing table and find the centre</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">)):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

            <span class="n">centre</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">center_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fullname</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;guess&quot;</span><span class="p">:</span>
                    <span class="n">ldtype</span> <span class="o">=</span> <span class="p">[</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">dict_dtype</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ldtype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not guess type of file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> - Skipping&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">thistype</span> <span class="o">=</span> <span class="n">ldtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">thistype</span> <span class="o">=</span> <span class="n">dtype</span>

                <span class="k">if</span> <span class="n">thistype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;cube&quot;</span><span class="p">]:</span>
                    <span class="n">centre</span> <span class="o">=</span> <span class="n">get_centre_from_image_or_cube</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">thistype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">centre</span> <span class="o">=</span> <span class="n">get_centre_from_pixtable</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">center_dict</span><span class="p">:</span>
                    <span class="n">centre</span> <span class="o">=</span> <span class="n">center_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>

            <span class="c1"># Assigning the centre to the right row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">[</span><span class="s1">&#39;centre&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">centre</span>

<div class="viewcode-block" id="PointingTable.assign_pointings"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.PointingTable.assign_pointings">[docs]</a>    <span class="k">def</span> <span class="nf">assign_pointings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign pointing according to distance rules. Will also update the centre values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">overwrite</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_pointing</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">center_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_pointing_dict</span> <span class="o">=</span> \
            <span class="n">group_exposures_per_pointing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_filenames</span><span class="p">,</span> <span class="n">target_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Assign centres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_centres</span><span class="p">(</span><span class="n">center_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_dict</span><span class="p">)</span>

        <span class="c1"># Now writing the pointing in the pointing table</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assigning Pointings ---&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_pointing_dict</span><span class="p">:</span>
            <span class="n">pointing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_pointing_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">[</span><span class="s1">&#39;pointing&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">pointing</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> = Pointing </span><span class="si">{</span><span class="n">pointing</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PointingTable.select_from_list"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.util_image.PointingTable.select_from_list">[docs]</a>    <span class="k">def</span> <span class="nf">select_from_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select all filenames with that pointing number.</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        **kwargs: default lists are empty ones</span>
<span class="sd">            Valid keywords are:</span>
<span class="sd">                list_datasets: list of int</span>
<span class="sd">                list_pointings: list of int</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        An astropy table selected according to the list of datasets and pointings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_pointings</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;list_pointings&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">list_datasets</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;list_datasets&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># Now getting the selections</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">)):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">[</span><span class="s1">&#39;pointing&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">list_pointings</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">list_datasets</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of filenames following the selection</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list_filename</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pointing_table&#39;</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Missing a pointing table - returning an empty filename list&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="o">.</span><span class="n">loc_indices</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">lfiles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing_table</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">][</span><span class="n">inds</span><span class="p">])</span>
        <span class="n">lfiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">lfiles</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Eric Emsellem.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>