<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pymusepipe.mpdaf_pipe &mdash; pymusepipe 2.19.9 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> pymusepipe
          </a>
              <div class="version">
                2.19.9
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../welcome.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alignment.html">Alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mosaicking.html">Mosaicking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../convolution.html">Convolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../phangs_example.html">PHANGS pipeline example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">Module Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pymusepipe</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pymusepipe.mpdaf_pipe</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pymusepipe.mpdaf_pipe</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a MIT license - see LICENSE</span>

<span class="sd">&quot;&quot;&quot;MUSE-PHANGS mpdaf-functions module</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__authors__</span>   <span class="o">=</span> <span class="s2">&quot;Eric Emsellem&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;(c) 2017, ESO + CRAL&quot;</span>
<span class="n">__license__</span>   <span class="o">=</span> <span class="s2">&quot;MIT License&quot;</span>
<span class="n">__contact__</span>   <span class="o">=</span> <span class="s2">&quot; &lt;eric.emsellem@eso.org&gt;&quot;</span>

<span class="c1"># This module uses some mpdaf routines and wrap some of their</span>
<span class="c1"># functionalities to help the muse_pipe checkups</span>

<span class="c1"># Importing modules</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ma</span>

<span class="c1"># Standard modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">joinpath</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c1"># Importing mpdaf</span>
<span class="k">try</span> <span class="p">:</span>
    <span class="kn">import</span> <span class="nn">mpdaf</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;mpdaf is required for this - MUSE related - module&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">mpdaf.obj</span> <span class="kn">import</span> <span class="n">Cube</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">CubeMosaic</span><span class="p">,</span> <span class="n">DataArray</span>
<span class="kn">from</span> <span class="nn">mpdaf.obj</span> <span class="kn">import</span> <span class="n">Spectrum</span><span class="p">,</span> <span class="n">WaveCoord</span>
<span class="kn">from</span> <span class="nn">mpdaf.tools</span> <span class="kn">import</span> <span class="n">add_mpdaf_method_keywords</span>
<span class="kn">from</span> <span class="nn">mpdaf.drs</span> <span class="kn">import</span> <span class="n">PixTable</span>

<span class="c1"># Astropy</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> <span class="k">as</span> <span class="n">pyfits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>

<span class="c1"># Scipy erosion</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span>

<span class="kn">import</span> <span class="nn">pymusepipe</span>
<span class="kn">from</span> <span class="nn">.config_pipe</span> <span class="kn">import</span> <span class="n">default_wave_wcs</span><span class="p">,</span> <span class="n">ao_mask_lambda</span><span class="p">,</span> <span class="n">dict_extra_filters</span>
<span class="kn">from</span> <span class="nn">.util_pipe</span> <span class="kn">import</span> <span class="p">(</span><span class="n">filter_list_with_pdict</span><span class="p">,</span> <span class="n">filter_list_with_suffix_list</span><span class="p">,</span>\
                        <span class="n">add_string</span><span class="p">,</span> <span class="n">default_str_dataset</span><span class="p">,</span> <span class="n">default_ndigits</span><span class="p">,</span>
                        <span class="n">get_dataset_name</span><span class="p">,</span> <span class="n">check_filter_list</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.util_pipe</span> <span class="kn">import</span> <span class="p">(</span><span class="n">print_error</span><span class="p">,</span> <span class="n">print_info</span><span class="p">,</span> <span class="n">print_warning</span><span class="p">,</span> <span class="n">print_debug</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cube_convolve</span> <span class="kn">import</span> <span class="n">cube_kernel</span><span class="p">,</span> <span class="n">cube_convolve</span>
<span class="kn">from</span> <span class="nn">.emission_lines</span> <span class="kn">import</span> <span class="n">get_emissionline_band</span>


<div class="viewcode-block" id="get_sky_spectrum"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.get_sky_spectrum">[docs]</a><span class="k">def</span> <span class="nf">get_sky_spectrum</span><span class="p">(</span><span class="n">specname</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read sky spectrum from MUSE data reduction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">specname</span><span class="p">):</span>
        <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specname</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">sky</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">specname</span><span class="p">)</span>
    <span class="n">crval</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[</span><span class="s1">&#39;lambda&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cdelt</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[</span><span class="s1">&#39;lambda&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">crval</span>
    <span class="n">wavein</span> <span class="o">=</span> <span class="n">WaveCoord</span><span class="p">(</span><span class="n">cdelt</span><span class="o">=</span><span class="n">cdelt</span><span class="p">,</span> <span class="n">crval</span><span class="o">=</span><span class="n">crval</span><span class="p">,</span> <span class="n">cunit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">wave</span><span class="o">=</span><span class="n">wavein</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sky</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">var</span><span class="o">=</span><span class="n">sky</span><span class="p">[</span><span class="s1">&#39;stat&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">spec</span></div>


<div class="viewcode-block" id="integrate_spectrum"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.integrate_spectrum">[docs]</a><span class="k">def</span> <span class="nf">integrate_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">wave_filter</span><span class="p">,</span> <span class="n">throughput_filter</span><span class="p">,</span> <span class="n">ao_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Integrate a spectrum using a certain Muse Filter file.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    spectrum: Spectrum</span>
<span class="sd">        Input spectrum given as an mpdaf Spectrum</span>
<span class="sd">    wave_filter: float array</span>
<span class="sd">        Array of wavelength for the filter</span>
<span class="sd">    throughput_filter: float array</span>
<span class="sd">        Array of throughput (between 0 and 1) for the filter. Should be the </span>
<span class="sd">        same dimension (1D, N floats) as wave_filter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># interpolation linearly the filter throughput onto</span>
    <span class="c1"># the spectrum wavelength</span>
    <span class="n">specwave</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">wave</span><span class="o">.</span><span class="n">coord</span><span class="p">()</span>
    <span class="n">specdata</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># If we have an AO mask, we interpolate the spectrum within that range</span>
    <span class="k">if</span> <span class="n">ao_mask</span><span class="p">:</span>
        <span class="n">outside_AO</span> <span class="o">=</span> <span class="p">(</span><span class="n">specwave</span> <span class="o">&lt;</span> <span class="n">ao_mask_lambda</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">specwave</span> <span class="o">&gt;</span> <span class="n">ao_mask_lambda</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">good_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">specwave</span><span class="p">,</span> <span class="n">specwave</span><span class="p">[</span><span class="n">outside_AO</span><span class="p">],</span>
                                  <span class="n">specdata</span><span class="p">[</span><span class="n">outside_AO</span><span class="p">])</span>
        <span class="c1"># Replacing the interval with interpolated spectrum</span>
        <span class="n">specdata</span><span class="p">[</span><span class="o">~</span><span class="n">outside_AO</span><span class="p">]</span> <span class="o">=</span> <span class="n">good_spectrum</span><span class="p">[</span><span class="o">~</span><span class="n">outside_AO</span><span class="p">]</span>

    <span class="n">effS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">specwave</span><span class="p">,</span> <span class="n">wave_filter</span><span class="p">,</span> <span class="n">throughput_filter</span><span class="p">)</span>
    <span class="c1"># Retaining only positive values</span>
    <span class="n">goodpix</span> <span class="o">=</span> <span class="p">(</span><span class="n">effS</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">filtwave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">effS</span><span class="p">[</span><span class="n">goodpix</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">filtwave</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">flux_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">goodpix</span><span class="p">]</span> <span class="o">*</span> <span class="n">effS</span><span class="p">[</span><span class="n">goodpix</span><span class="p">])</span> <span class="o">/</span> <span class="n">filtwave</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flux_cont</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">flux_cont</span></div>


<div class="viewcode-block" id="rotate_image_wcs"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.rotate_image_wcs">[docs]</a><span class="k">def</span> <span class="nf">rotate_image_wcs</span><span class="p">(</span><span class="n">ima_name</span><span class="p">,</span> <span class="n">ima_folder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">outwcs_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotangle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Routine to remove potential Nan around an image and reconstruct</span>
<span class="sd">    an optimal WCS reference image. The rotation angle is provided as a way</span>
<span class="sd">    to optimise the extent of the output image, removing Nan along X and Y</span>
<span class="sd">    at that angle.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    ima_name: str</span>
<span class="sd">        input image name. No default.</span>
<span class="sd">    ima_folder: str default=&#39;&#39;, optional</span>
<span class="sd">        input image folder</span>
<span class="sd">    outwcs_folder: str, optional</span>
<span class="sd">        folder where to write the output frame. Default is</span>
<span class="sd">        None which means that it will use the folder of the input image.</span>
<span class="sd">    rotangle: float default=0, optional</span>
<span class="sd">        rotation angle in degrees</span>
<span class="sd">    in_suffix: str default=&#39;prealign&#39;</span>
<span class="sd">        in suffix to remove from name</span>
<span class="sd">    out_suffix: str default=&#39;rotwcs&#39;</span>
<span class="sd">        out suffix to add to name</span>
<span class="sd">    margin_factor: float</span>
<span class="sd">        factor to extend the image [1.1]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Reading the input names and setting output folder</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">ima_folder</span><span class="p">,</span> <span class="n">ima_name</span><span class="p">)</span>
    <span class="n">ima_folder</span><span class="p">,</span> <span class="n">ima_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outwcs_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outwcs_folder</span> <span class="o">=</span> <span class="n">ima_folder</span>

    <span class="c1"># Suffix</span>
    <span class="n">in_suffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;in_suffix&quot;</span><span class="p">,</span> <span class="s2">&quot;prealign&quot;</span><span class="p">)</span>
    <span class="n">out_suffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;out_suffix&quot;</span><span class="p">,</span> <span class="s2">&quot;rotwcs&quot;</span><span class="p">)</span>

    <span class="c1"># Get margin if needed</span>
    <span class="n">margin_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;margin_factor&quot;</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
    <span class="n">extend_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">margin_factor</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">))</span>
    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Will use a </span><span class="si">{:5.2f}% e</span><span class="s2">xtra margin&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="n">extend_fraction</span><span class="o">*</span><span class="mf">100.</span><span class="p">))</span>

    <span class="c1"># Opening the image via mpdaf</span>
    <span class="n">imawcs</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
    <span class="n">extra_pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imawcs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">extend_fraction</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># New dimensions and extend current image</span>
    <span class="n">new_dim</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imawcs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra_pixels</span><span class="p">)</span>
    <span class="n">ima_ext</span> <span class="o">=</span> <span class="n">imawcs</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">newdim</span><span class="o">=</span><span class="n">new_dim</span><span class="p">,</span> <span class="n">refpos</span><span class="o">=</span><span class="n">imawcs</span><span class="o">.</span><span class="n">get_start</span><span class="p">(),</span>
                            <span class="n">refpix</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">extra_pixels</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">),</span>
                            <span class="n">newinc</span><span class="o">=</span><span class="n">imawcs</span><span class="o">.</span><span class="n">get_step</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">3600.</span><span class="p">)</span>

    <span class="c1"># Copy and rotate WCS</span>
    <span class="n">new_wcs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ima_ext</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Rotating WCS by </span><span class="si">{}</span><span class="s2"> degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rotangle</span><span class="p">))</span>
    <span class="n">new_wcs</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">rotangle</span><span class="p">)</span>

    <span class="c1"># New rotated image</span>
    <span class="n">ima_rot</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">ima_ext</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">wcs</span><span class="o">=</span><span class="n">new_wcs</span><span class="p">)</span>

    <span class="c1"># Then resample the image using the initial one as your reference</span>
    <span class="n">ima_rot_resampled</span> <span class="o">=</span> <span class="n">ima_rot</span><span class="o">.</span><span class="n">align_with_image</span><span class="p">(</span><span class="n">ima_ext</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Crop NaN</span>
    <span class="n">ima_rot_resampled</span><span class="o">.</span><span class="n">crop</span><span class="p">()</span>

    <span class="c1"># get the new header with wcs and rotate back</span>
    <span class="n">finalwcs</span> <span class="o">=</span> <span class="n">ima_rot_resampled</span><span class="o">.</span><span class="n">wcs</span>
    <span class="n">finalwcs</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">rotangle</span><span class="p">)</span>

    <span class="c1"># create the final image</span>
    <span class="n">final_rot_image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ima_rot_resampled</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">finalwcs</span><span class="p">)</span>

    <span class="c1"># Save image</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">in_suffix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">in_suffix</span> <span class="ow">in</span> <span class="n">ima_name</span><span class="p">:</span>
            <span class="n">out_name</span> <span class="o">=</span> <span class="n">ima_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">in_suffix</span><span class="p">,</span> <span class="n">out_suffix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">ima_name</span><span class="p">)</span>
        <span class="n">out_suffix</span> <span class="o">=</span> <span class="n">add_string</span><span class="p">(</span><span class="n">out_suffix</span><span class="p">)</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">out_suffix</span><span class="p">,</span> <span class="n">extension</span><span class="p">)</span>

    <span class="c1"># write output</span>
    <span class="n">final_rot_image</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">outwcs_folder</span><span class="p">,</span> <span class="n">out_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">outwcs_folder</span><span class="p">,</span> <span class="n">out_name</span></div>


<div class="viewcode-block" id="rotate_cube_wcs"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.rotate_cube_wcs">[docs]</a><span class="k">def</span> <span class="nf">rotate_cube_wcs</span><span class="p">(</span><span class="n">cube_name</span><span class="p">,</span> <span class="n">cube_folder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">outwcs_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotangle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Routine to remove potential Nan around an image and reconstruct</span>
<span class="sd">    an optimal WCS reference image. The rotation angle is provided as a way</span>
<span class="sd">    to optimise the extent of the output image, removing Nan along X and Y</span>
<span class="sd">    at that angle.</span>

<span class="sd">    Args:</span>
<span class="sd">        cube_name (str): input image name. No default.</span>
<span class="sd">        cube_folder (str): input image folder [&#39;&#39;]</span>
<span class="sd">        outwcs_folder (str): folder where to write the output frame. Default is</span>
<span class="sd">            None which means that it will use the folder of the input image.</span>
<span class="sd">        rotangle (float): rotation angle in degrees [0]</span>
<span class="sd">        **kwargs:</span>
<span class="sd">            in_suffix (str): in suffix to remove from name [&#39;prealign&#39;]</span>
<span class="sd">            out_suffix (str): out suffix to add to name [&#39;rotwcs&#39;]</span>
<span class="sd">            margin_factor (float): factor to extend the image [1.1]</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Reading the input names and setting output folder</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">cube_folder</span><span class="p">,</span> <span class="n">cube_name</span><span class="p">)</span>
    <span class="n">cube_folder</span><span class="p">,</span> <span class="n">cube_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outwcs_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outwcs_folder</span> <span class="o">=</span> <span class="n">cube_folder</span>

    <span class="c1"># Suffix</span>
    <span class="n">in_suffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;in_suffix&quot;</span><span class="p">,</span> <span class="s2">&quot;prealign&quot;</span><span class="p">)</span>
    <span class="n">out_suffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;out_suffix&quot;</span><span class="p">,</span> <span class="s2">&quot;rotwcs&quot;</span><span class="p">)</span>

    <span class="c1"># Get margin if needed</span>
    <span class="n">margin_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;margin_factor&quot;</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
    <span class="n">extend_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">margin_factor</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">))</span>
    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Will use a </span><span class="si">{:5.2f}% e</span><span class="s2">xtra margin&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="n">extend_fraction</span><span class="o">*</span><span class="mf">100.</span><span class="p">))</span>

    <span class="c1"># Opening the image via mpdaf</span>
    <span class="n">cubewcs</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
    <span class="n">imawcs</span> <span class="o">=</span> <span class="n">cubewcs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">extra_pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imawcs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">extend_fraction</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># New dimensions and extend current image</span>
    <span class="n">new_dim</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imawcs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra_pixels</span><span class="p">)</span>
    <span class="n">ima_ext</span> <span class="o">=</span> <span class="n">imawcs</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">newdim</span><span class="o">=</span><span class="n">new_dim</span><span class="p">,</span> <span class="n">refpos</span><span class="o">=</span><span class="n">imawcs</span><span class="o">.</span><span class="n">get_start</span><span class="p">(),</span>
                            <span class="n">refpix</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">extra_pixels</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">),</span>
                            <span class="n">newinc</span><span class="o">=</span><span class="n">imawcs</span><span class="o">.</span><span class="n">get_step</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">3600.</span><span class="p">)</span>

    <span class="c1"># Copy and rotate WCS</span>
    <span class="n">new_wcs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ima_ext</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
    <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Rotating spatial WCS of Cube by </span><span class="si">{}</span><span class="s2"> degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rotangle</span><span class="p">))</span>
    <span class="n">new_wcs</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">rotangle</span><span class="p">)</span>

    <span class="c1"># New rotated image</span>
    <span class="n">ima_rot</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">ima_ext</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">wcs</span><span class="o">=</span><span class="n">new_wcs</span><span class="p">)</span>

    <span class="c1"># Then resample the image using the initial one as your reference</span>
    <span class="n">ima_rot_resampled</span> <span class="o">=</span> <span class="n">ima_rot</span><span class="o">.</span><span class="n">align_with_image</span><span class="p">(</span><span class="n">ima_ext</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Crop NaN</span>
    <span class="n">ima_rot_resampled</span><span class="o">.</span><span class="n">crop</span><span class="p">()</span>

    <span class="c1"># get the new header with wcs and rotate back</span>
    <span class="n">finalwcs</span> <span class="o">=</span> <span class="n">ima_rot_resampled</span><span class="o">.</span><span class="n">wcs</span>
    <span class="n">finalwcs</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">rotangle</span><span class="p">)</span>

    <span class="c1"># create the final image</span>
    <span class="n">data_cube_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ima_rot_resampled</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                              <span class="n">cubewcs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">final_rot_cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_cube_rot</span><span class="p">,</span> <span class="n">wave</span><span class="o">=</span><span class="n">cubewcs</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">finalwcs</span><span class="p">)</span>

    <span class="c1"># Save image</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">in_suffix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">in_suffix</span> <span class="ow">in</span> <span class="n">cube_name</span><span class="p">:</span>
            <span class="n">out_name</span> <span class="o">=</span> <span class="n">cube_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">in_suffix</span><span class="p">,</span> <span class="n">out_suffix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">cube_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out_suffix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">out_suffix</span> <span class="o">=</span> <span class="n">add_string</span><span class="p">(</span><span class="n">out_suffix</span><span class="p">)</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">out_suffix</span><span class="p">,</span> <span class="n">extension</span><span class="p">)</span>

    <span class="c1"># write output</span>
    <span class="n">final_rot_cube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">outwcs_folder</span><span class="p">,</span> <span class="n">out_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">outwcs_folder</span><span class="p">,</span> <span class="n">out_name</span></div>


<div class="viewcode-block" id="get_centre_from_pixtable"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.get_centre_from_pixtable">[docs]</a><span class="k">def</span> <span class="nf">get_centre_from_pixtable</span><span class="p">(</span><span class="n">pixtable_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the center of the FOV from pixtables</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    pixtable_name: str</span>
<span class="sd">        name of the pixeltable</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SkyCoord: astropy.coordinates.Skycoord</span>
<span class="sd">        Coordinates of the center of the field</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">PixTable</span><span class="p">(</span><span class="n">pixtable_name</span><span class="p">)</span>

    <span class="c1"># get the x and y coordinates of each pixel</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_xpos</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_ypos</span><span class="p">()</span>

    <span class="c1"># it seems like the x and y are the position from the center of the field</span>
    <span class="c1"># see: https://mpdaf.readthedocs.io/en/latest/pixtable.html#pixtable-format</span>
    <span class="c1"># so the centre should just be the pixel close to 0 in both dimensions</span>

    <span class="n">xcen_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">ycen_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

    <span class="n">xcen</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">xcen_id</span><span class="p">]</span>
    <span class="n">ycen</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ycen_id</span><span class="p">]</span>

    <span class="c1"># get the position on the sky of the barycenter</span>
    <span class="c1"># and transform to SkyCoord for consistency</span>
    <span class="n">bary</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_pos_sky</span><span class="p">(</span><span class="n">xcen</span><span class="p">,</span> <span class="n">ycen</span><span class="p">)</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">bary</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bary</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

    <span class="c1"># Printing the result</span>
    <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pixtable_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">coord</span></div>


<div class="viewcode-block" id="BasicPSF"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.BasicPSF">[docs]</a><span class="k">class</span> <span class="nc">BasicPSF</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Basic PSF function and parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">fwhm0</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">nmoffat</span><span class="o">=</span><span class="mf">2.8</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                 <span class="n">l0</span><span class="o">=</span><span class="mf">6483.58</span><span class="p">,</span> <span class="n">psf_array</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">psf_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">psf_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm0</span> <span class="o">=</span> <span class="n">psf_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmoffat</span> <span class="o">=</span> <span class="n">psf_array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">psf_array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l0</span> <span class="o">=</span> <span class="n">psf_array</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm0</span> <span class="o">=</span> <span class="n">fwhm0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmoffat</span> <span class="o">=</span> <span class="n">nmoffat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l0</span> <span class="o">=</span> <span class="n">l0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">psf_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmoffat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">]</span></div>

<div class="viewcode-block" id="BasicFile"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.BasicFile">[docs]</a><span class="k">class</span> <span class="nc">BasicFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Basic file with just the name and some properties</span>
<span class="sd">    to attach to that Cube</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span></div>


<div class="viewcode-block" id="MuseCubeMosaic"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCubeMosaic">[docs]</a><span class="k">class</span> <span class="nc">MuseCubeMosaic</span><span class="p">(</span><span class="n">CubeMosaic</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_wcs</span><span class="p">,</span> <span class="n">folder_ref_wcs</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">folder_cubes</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">prefix_cubes</span><span class="o">=</span><span class="s2">&quot;DATACUBE_FINAL_WCS&quot;</span><span class="p">,</span>
                 <span class="n">list_suffix</span><span class="o">=</span><span class="p">[],</span> <span class="n">use_fixed_cubes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">excluded_suffix</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">included_suffix</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">prefix_fixed_cubes</span><span class="o">=</span><span class="s2">&quot;tmask&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">dict_exposures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dict_psf</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">list_cubes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_cubes</span> <span class="o">=</span> <span class="n">folder_cubes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_ref_wcs</span> <span class="o">=</span> <span class="n">folder_ref_wcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_wcs</span> <span class="o">=</span> <span class="n">ref_wcs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_folder</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_wcs_name</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_ref_wcs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_wcs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_cubes</span> <span class="o">=</span> <span class="n">prefix_cubes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_suffix</span> <span class="o">=</span> <span class="n">list_suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excluded_suffix</span> <span class="o">=</span> <span class="n">excluded_suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">included_suffix</span> <span class="o">=</span> <span class="n">included_suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_fixed_cubes</span> <span class="o">=</span> <span class="n">prefix_fixed_cubes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_fixed_cubes</span> <span class="o">=</span> <span class="n">use_fixed_cubes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_exposures</span> <span class="o">=</span> <span class="n">dict_exposures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_psf</span> <span class="o">=</span> <span class="n">dict_psf</span>

        <span class="c1"># Building the list of cubes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_list</span><span class="p">(</span><span class="n">list_cubes</span><span class="o">=</span><span class="n">list_cubes</span><span class="p">)</span>

        <span class="c1"># Initialise the super class</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuseCubeMosaic</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_wcs_name</span><span class="p">)</span>

        <span class="c1"># Check unit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_unit</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cube_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">filename</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_cubes</span><span class="p">]</span>

<div class="viewcode-block" id="MuseCubeMosaic.print_cube_names"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCubeMosaic.print_cube_names">[docs]</a>    <span class="k">def</span> <span class="nf">print_cube_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lnames</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_names</span><span class="p">)</span>
        <span class="n">lnames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mosaic Cubes ==========================&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lnames</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=======================================&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncubes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_cubes</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">list_cubes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_list_cubes&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_list_cubes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_cubes</span>

    <span class="nd">@list_cubes</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">list_cubes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_list_cubes</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_check_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_cubes</span><span class="p">):</span>
            <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Cube Folder </span><span class="si">{}</span><span class="s2"> does not exists </span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot;- Aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_cubes</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_ref_wcs</span><span class="p">):</span>
            <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;WCS Folder </span><span class="si">{}</span><span class="s2"> does not exists </span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot;- Aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_ref_wcs</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_get_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">list_units</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube_names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">list_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cube</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">u_units</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">list_units</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_units</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: no unit found in input cubes, will set dimensionless one&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">u_units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">u_units</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: units are not all the same for all input Cubes. &quot;</span>
                      <span class="s2">&quot;  Selecting the first encountered&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unit of mosaiced Cube = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MuseCubeMosaic.build_list"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCubeMosaic.build_list">[docs]</a>    <span class="k">def</span> <span class="nf">build_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_cubes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix_cubes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_cubes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Building the list of cubes to process</span>

<span class="sd">        Args:</span>
<span class="sd">            folder_cubes (str): folder for the cubes</span>
<span class="sd">            prefix_cubes (str): prefix to be used</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">print_info</span><span class="p">(</span><span class="s1">&#39;Building the list of appropriate Cubes for the mosaick&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_suffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;list_suffix&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_suffix</span><span class="p">)</span>
        <span class="c1"># Get the folder if needed</span>
        <span class="k">if</span> <span class="n">folder_cubes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder_cubes</span> <span class="o">=</span> <span class="n">folder_cubes</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_folder</span><span class="p">():</span>
                <span class="k">return</span>

        <span class="c1"># get the prefix if provided</span>
        <span class="k">if</span> <span class="n">prefix_cubes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix_cubes</span> <span class="o">=</span> <span class="n">prefix_cubes</span>

        <span class="k">if</span> <span class="n">list_cubes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get the list of cubes and return if 0 found</span>
            <span class="n">list_existing_cubes</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">*.fits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_cubes</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">prefix_cubes</span><span class="p">))</span>

            <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_existing_cubes</span><span class="p">)</span><span class="si">}</span><span class="s2"> existing Cubes &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;in this folder with prefix </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_cubes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># if the list of exclusion suffix is empty, just use all cubes</span>
            <span class="n">list_existing_cubes</span> <span class="o">=</span> <span class="n">filter_list_with_suffix_list</span><span class="p">(</span><span class="n">list_existing_cubes</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">included_suffix</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">excluded_suffix</span><span class="p">,</span>
                                                               <span class="n">name_list</span><span class="o">=</span><span class="s2">&quot;Existing Cubes&quot;</span><span class="p">)</span>
            <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> Cubes after suffix filtering&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">list_existing_cubes</span><span class="p">)))</span>

            <span class="c1"># Filter the list with the pointing dictionary if given</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_exposures</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Will be using a dictionary for &quot;</span>
                                 <span class="s2">&quot;further selecting the appropriate cubes&quot;</span><span class="p">)</span>
            <span class="n">list_cubes</span><span class="p">,</span> <span class="n">dict_exposures_per_pointing</span><span class="p">,</span> <span class="n">dict_tplexpo_per_pointing</span><span class="p">,</span>\
                <span class="n">dict_tplexpo_per_dataset</span> <span class="o">=</span> <span class="n">filter_list_with_pdict</span><span class="p">(</span><span class="n">list_existing_cubes</span><span class="p">,</span>
                                                                  <span class="n">list_datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                  <span class="n">dict_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_exposures</span><span class="p">)</span>

            <span class="c1"># Take (or not) the fixed Cubes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_fixed_cubes</span><span class="p">:</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Using Corrected cubes with prefix </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                    <span class="s2">&quot;when relevant&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_fixed_cubes</span><span class="p">))</span>
                <span class="n">prefix_to_consider</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_fixed_cubes</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">prefix_cubes</span><span class="p">)</span>
                <span class="n">list_fixed_cubes</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">*fits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">folder_cubes</span><span class="p">,</span>
                                                   <span class="n">prefix_to_consider</span><span class="p">))</span>
                <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Initial set of </span><span class="si">{:02d}</span><span class="s2"> Corrected &quot;</span>
                                 <span class="s2">&quot;cubes found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_fixed_cubes</span><span class="p">)))</span>

                <span class="c1"># if the list of exclusion suffix is empty, just use all cubes</span>
                <span class="n">list_fixed_cubes</span> <span class="o">=</span> <span class="n">filter_list_with_suffix_list</span><span class="p">(</span><span class="n">list_fixed_cubes</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">included_suffix</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">excluded_suffix</span><span class="p">,</span>
                                                          <span class="n">name_list</span><span class="o">=</span><span class="s2">&quot;Fixed Cubes&quot;</span><span class="p">)</span>

                <span class="c1"># Looping over the existing fixed pixtables</span>
                <span class="k">for</span> <span class="n">fixed_cube</span> <span class="ow">in</span> <span class="n">list_fixed_cubes</span><span class="p">:</span>
                    <span class="c1"># Finding the name of the original one</span>
                    <span class="n">orig_cube</span> <span class="o">=</span> <span class="n">fixed_cube</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix_to_consider</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">prefix_cubes</span><span class="p">)</span>
                    <span class="n">temp_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">list_cubes</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">orig_cube</span> <span class="ow">in</span> <span class="n">temp_list</span><span class="p">:</span>
                        <span class="c1"># If it exists, remove it</span>
                        <span class="n">list_cubes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">orig_cube</span><span class="p">)</span>
                        <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cube </span><span class="si">{</span><span class="n">orig_cube</span><span class="si">}</span><span class="s2"> was removed from &quot;</span>
                                            <span class="sa">f</span><span class="s2">&quot;the list (fixed one will be used)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original Cube </span><span class="si">{</span><span class="n">orig_cube</span><span class="si">}</span><span class="s2"> not &quot;</span>
                                            <span class="sa">f</span><span class="s2">&quot;found (but fixed cube will &quot;</span>
                                            <span class="sa">f</span><span class="s2">&quot;be used nevertheless)&quot;</span><span class="p">)</span>
                    <span class="c1"># and add the fixed one</span>
                    <span class="n">list_cubes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fixed_cube</span><span class="p">)</span>
                    <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fixed Cube </span><span class="si">{</span><span class="n">fixed_cube</span><span class="si">}</span><span class="s2"> has been included &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;in the list&quot;</span><span class="p">)</span>

            <span class="c1"># if the list of suffix is empty, just use all cubes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_suffix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Filtering out the ones that don&#39;t have any of the suffixes</span>
                <span class="n">temp_list_cubes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">list_cubes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">suff</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">for</span> <span class="n">suff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_suffix</span><span class="p">]):</span>
                        <span class="n">temp_list_cubes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="n">list_cubes</span> <span class="o">=</span> <span class="n">temp_list_cubes</span>

        <span class="c1"># Attach the other properties to the list of cubes (e.g. PSF)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_cubes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Names for the OBs</span>
        <span class="n">str_dataset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;str_dataset&quot;</span><span class="p">,</span> <span class="n">default_str_dataset</span><span class="p">)</span>
        <span class="n">ndigits</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ndigits&quot;</span><span class="p">,</span> <span class="n">default_ndigits</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">list_cubes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_cubes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BasicFile</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_psf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_psf</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">keyword</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_cubes</span><span class="si">}</span><span class="s2">_&quot;</span> \
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_dataset_name</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">str_dataset</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                        <span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_psf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">list_cubes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="n">BasicPSF</span><span class="p">(</span><span class="n">psf_array</span><span class="o">=</span><span class="n">psf</span><span class="p">)</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># If none correspond, set to the 0 FWHM Gaussian</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No PSF found for cube </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">. &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;Using default&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_cubes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="n">BasicPSF</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_cubes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="n">BasicPSF</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_cubes</span><span class="p">):</span>
                <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Cube </span><span class="si">{0:03d}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncubes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Found 0 cubes in this folder with suffix&quot;</span>
                              <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">: please change suffix&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">prefix_cubes</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> cubes to be processed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">ncubes</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseCubeMosaic.convolve_cubes"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCubeMosaic.convolve_cubes">[docs]</a>    <span class="k">def</span> <span class="nf">convolve_cubes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_fwhm</span><span class="p">,</span> <span class="n">target_nmoffat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">target_function</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;conv&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            target_fwhm:</span>
<span class="sd">            target_nmoffat:</span>
<span class="sd">            input_function:</span>
<span class="sd">            target_function:</span>
<span class="sd">            suffix:</span>
<span class="sd">            **kwargs:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convolving cube per cube</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_cubes</span><span class="p">):</span>
            <span class="c1"># Removing the input folder</span>
            <span class="n">folder</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="c1"># Getting just the name and the extension</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">outcube_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">MuseCube</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">psf_array</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">psf_array</span><span class="p">)</span>
            <span class="n">cube_folder</span><span class="p">,</span> <span class="n">outcube_name</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">convolve_cube_to_psf</span><span class="p">(</span><span class="n">target_fwhm</span><span class="p">,</span>
                                      <span class="n">target_nmoffat</span><span class="o">=</span><span class="n">target_nmoffat</span><span class="p">,</span>
                                      <span class="n">target_function</span><span class="o">=</span><span class="n">target_function</span><span class="p">,</span>
                                      <span class="n">outcube_name</span><span class="o">=</span><span class="n">outcube_name</span><span class="p">,</span>
                                      <span class="n">outcube_folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># updating the convolved cube name</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">BasicPSF</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">target_function</span><span class="p">,</span> <span class="n">fwhm0</span><span class="o">=</span><span class="n">target_fwhm</span><span class="p">,</span>
                           <span class="n">nmoffat</span><span class="o">=</span><span class="n">target_nmoffat</span><span class="p">,</span> <span class="n">l0</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">l0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_cubes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BasicFile</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">cube_folder</span><span class="p">,</span><span class="n">outcube_name</span><span class="p">),</span>
                                           <span class="n">psf</span><span class="o">=</span><span class="n">psf</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseCubeMosaic.madcombine"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCubeMosaic.madcombine">[docs]</a>    <span class="k">def</span> <span class="nf">madcombine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_cubes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outcube_name</span><span class="o">=</span><span class="s2">&quot;dummy.fits&quot;</span><span class="p">,</span>
                   <span class="n">fakemode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mad</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine the CubeMosaic and write it out.</span>

<span class="sd">        Args:</span>
<span class="sd">            folder_cubes (str): name of the folder for the cube [None]</span>
<span class="sd">            outcube_name (str): name of the outcube</span>
<span class="sd">            mad (bool): using mad or not [True]</span>

<span class="sd">        Creates:</span>
<span class="sd">            A new cube, combination of all input cubes listes in CubeMosaic</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Combine</span>
        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Starting the combine of &quot;</span>
                         <span class="s2">&quot;all </span><span class="si">{}</span><span class="s2"> input cubes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncubes</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fakemode</span><span class="p">:</span>
            <span class="n">cube</span><span class="p">,</span> <span class="n">expmap</span><span class="p">,</span> <span class="n">statpix</span><span class="p">,</span> <span class="n">rejmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pycombine</span><span class="p">(</span><span class="n">mad</span><span class="o">=</span><span class="n">mad</span><span class="p">)</span>

        <span class="c1"># Saving</span>
        <span class="k">if</span> <span class="n">folder_cubes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder_cubes</span> <span class="o">=</span> <span class="n">folder_cubes</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_folder</span><span class="p">():</span>
                <span class="k">return</span>

        <span class="n">full_cube_name</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_cubes</span><span class="p">,</span> <span class="n">outcube_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mosaic_cube_name</span> <span class="o">=</span> <span class="n">full_cube_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fakemode</span><span class="p">:</span>
            <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Writing the new Cube </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_cube_name</span><span class="p">))</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">full_cube_name</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="MuseCube"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube">[docs]</a><span class="k">class</span> <span class="nc">MuseCube</span><span class="p">(</span><span class="n">Cube</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper around the mpdaf Cube functionalities</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialisation of the opening of a Cube</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># PSF for that Cube</span>
        <span class="n">psf_array</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;psf_array&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="n">BasicPSF</span><span class="p">(</span><span class="n">psf_array</span><span class="o">=</span><span class="n">psf_array</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">Cube</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="MuseCube.get_spectrum_from_cube"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.get_spectrum_from_cube">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectrum_from_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pixel_window</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Spectrum&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a spectrum from the cube with centre defined in pixels</span>
<span class="sd">        with nx, ny and a window of &#39;pixel_window&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nx</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span> <span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">ny</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span> <span class="n">ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">pixel_halfwindow</span> <span class="o">=</span> <span class="n">pixel_window</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">subcube</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span> <span class="n">ny</span> <span class="o">-</span> <span class="n">pixel_halfwindow</span><span class="p">:</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">pixel_halfwindow</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> 
                    <span class="n">nx</span> <span class="o">-</span> <span class="n">pixel_halfwindow</span><span class="p">:</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">pixel_halfwindow</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">MuseSpectrum</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">subcube</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseCube.get_whiteimage_from_cube"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.get_whiteimage_from_cube">[docs]</a>    <span class="k">def</span> <span class="nf">get_whiteimage_from_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">MuseImage</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;White Image&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseCube.get_image_from_cube"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.get_image_from_cube">[docs]</a>    <span class="k">def</span> <span class="nf">get_image_from_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">central_lambda</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lambda_window</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get image from integrated cube, with spectral pixel</span>
<span class="sd">        centred at central_lambda and with a lambda_window of lambda_window</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">central_lambda</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span> <span class="n">central_lambda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">lambda_halfwindow</span> <span class="o">=</span> <span class="n">lambda_window</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">MuseImage</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">central_lambda</span> <span class="o">-</span> <span class="n">lambda_halfwindow</span><span class="p">:</span> 
            <span class="n">central_lambda</span> <span class="o">+</span> <span class="n">lambda_halfwindow</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseCube.extract_onespectral_cube"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.extract_onespectral_cube">[docs]</a>    <span class="k">def</span> <span class="nf">extract_onespectral_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wave1</span><span class="o">=</span><span class="n">default_wave_wcs</span><span class="p">,</span> <span class="n">outcube_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a single pixel cube extracted from this one.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wave1 : float</span>
<span class="sd">            Value of the wavelength to extract. In Angstroems.</span>
<span class="sd">        outcube_name : str</span>
<span class="sd">            Name of the output cube</span>
<span class="sd">        prefix : str</span>
<span class="sd">            If outcube_name is None (default), use that prefix to append</span>
<span class="sd">            in front of the input cube name (same folder)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A new cube with only 2 lambda. To be used as a WCS reference for</span>
<span class="sd">        masks.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Find the wavelength</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="o">.</span><span class="n">pixel</span><span class="p">([</span><span class="n">wave1</span><span class="p">],</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># extracting the cube</span>
        <span class="n">subcube</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k1</span><span class="p">:</span><span class="n">k1</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="n">cube_folder</span><span class="p">,</span> <span class="n">cube_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outcube_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;l</span><span class="si">{0:.0f}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave1</span><span class="p">))</span>
            <span class="n">outcube_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">cube_name</span><span class="p">)</span>

        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Writing up single wave-cube </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;in folder </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outcube_name</span><span class="p">,</span> <span class="n">cube_folder</span><span class="p">))</span>
        <span class="n">subcube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">cube_folder</span><span class="p">,</span> <span class="n">outcube_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cube_folder</span><span class="p">,</span> <span class="n">outcube_name</span></div>

<div class="viewcode-block" id="MuseCube.rebin_spatial"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.rebin_spatial">[docs]</a>    <span class="k">def</span> <span class="nf">rebin_spatial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">full_covariance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine neighboring pixels to reduce the size of a cube by integer factors along each axis.</span>

<span class="sd">        Each output pixel is the mean of n pixels, where n is the product of the </span>
<span class="sd">        reduction factors in the factor argument.</span>
<span class="sd">        Uses mpdaf rebin function, but add a normalisation factor if mean=False (sum).</span>
<span class="sd">        It also updates the unit by just copying the old one.</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        factor :  (int or (int,int))</span>
<span class="sd">            Factor by which the spatial dimensions are reduced</span>
<span class="sd">        mean : bool</span>
<span class="sd">            If True, taking the mean, if False (default) summing</span>
<span class="sd">        inplace : bool</span>
<span class="sd">            If False (default) making a copy. Otherwise using the present cube.</span>
<span class="sd">        full_covariance: bool</span>
<span class="sd">            If True, will assume that spaxels are fully covariant. This means that</span>
<span class="sd">            the variance will be normalised by sqrt(N) where N is the number of </span>
<span class="sd">            summed spaxels. Default is False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Cube: rebinned cube</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We copy it to keep the unit :-(</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">inplace</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Use the same reduction factor for all dimensions?</span>
        <span class="c1"># Copy from the mpdaf _rebin (in data.py)</span>
        <span class="n">nfacarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">res</span><span class="o">.</span><span class="n">ndim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">nfacarr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">factor</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">nfacarr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">nfacarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Factor should be an integer or list/array of 2 or 3 integers&quot;</span><span class="p">)</span>
        <span class="n">spafactor</span> <span class="o">=</span> <span class="n">nfacarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">nfacarr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
       
        <span class="c1"># Do the rebin using the rebin method from mpdaf Cube</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">rebin</span><span class="p">(</span><span class="n">nfacarr</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Mean or Sum</span>
        <span class="k">if</span> <span class="n">mean</span><span class="p">:</span>
            <span class="n">norm_factor</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm_factor</span> <span class="o">=</span> <span class="n">spafactor</span>

        <span class="c1"># Now scaling the data and variances</span>
        <span class="n">res</span><span class="o">.</span><span class="n">_data</span> <span class="o">*=</span> <span class="n">norm_factor</span>
        <span class="n">res</span><span class="o">.</span><span class="n">_var</span> <span class="o">*=</span> <span class="n">norm_factor</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># If full covariance, the S/N does not change.</span>
        <span class="c1"># Hence by summing ns spaxels, the S/N should in principle increase by sqrt(ns)</span>
        <span class="c1"># 1- If not mean, it recovers the right factor for the surface</span>
        <span class="c1">#    Namely : data * norm_factor, var * norm_factor**2</span>
        <span class="c1"># 2- If full_covariance, the S/N does not change so we need to multiply the variance</span>
        <span class="c1">#    to compensate. Since the S/N increased by sqrt(ns), we multiply var * ns</span>
        <span class="k">if</span> <span class="n">full_covariance</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Full Covariance option is ON&quot;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">_var</span> <span class="o">*=</span> <span class="n">spafactor</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="MuseCube.astropy_convolve"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.astropy_convolve">[docs]</a>    <span class="k">def</span> <span class="nf">astropy_convolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convolve a DataArray with an array of the same number of dimensions</span>
<span class="sd">        using a specified convolution function.</span>

<span class="sd">        Copy of _convolve for a cube, but doing it per slice or not</span>

<span class="sd">        Masked values in self.data and self.var are replaced with</span>
<span class="sd">        zeros before the convolution is performed. However masked</span>
<span class="sd">        pixels in the input data remain masked in the output.</span>

<span class="sd">        Any variances in self.var are propagated correctly.</span>

<span class="sd">        If self.var exists, the variances are propagated using the equation::</span>

<span class="sd">            result.var = self.var (*) other**2</span>

<span class="sd">        where (*) indicates convolution. This equation can be derived</span>
<span class="sd">        by applying the usual rules of error-propagation to the</span>
<span class="sd">        discrete convolution equation.</span>

<span class="sd">        Uses `astropy.convolution.convolve_fft&#39; or &#39;astropy.convolution.convolve&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fft : boolean</span>
<span class="sd">            The convolution function to use, chosen from:</span>

<span class="sd">            - `astropy.convolution.convolve_fft&#39;</span>
<span class="sd">            - `astropy.convolution.convolve&#39;</span>

<span class="sd">            In general convolve_fft() is faster than convolve() except when</span>
<span class="sd">            other.data only contains a few pixels. However convolve_fft uses</span>
<span class="sd">            a lot more memory than convolve(), so convolve() is sometimes the</span>
<span class="sd">            only reasonable choice. In particular, convolve_fft allocates two</span>
<span class="sd">            arrays whose dimensions are the sum of self.shape and other.shape,</span>
<span class="sd">            rounded up to a power of two. These arrays can be impractically</span>
<span class="sd">            large for some input data-sets.</span>
<span class="sd">        other : DataArray or numpy.ndarray</span>
<span class="sd">          The array with which to convolve the contents of self.  This must</span>
<span class="sd">          have the same number of dimensions as self, but it can have fewer</span>
<span class="sd">          elements. When this array contains a symmetric filtering function,</span>
<span class="sd">          the center of the function should be placed at the center of pixel,</span>
<span class="sd">          ``(other.shape - 1)//2``.</span>

<span class="sd">          Note that passing a DataArray object is equivalent to just</span>
<span class="sd">          passing its DataArray.data member. If it has any variances,</span>
<span class="sd">          these are ignored.</span>
<span class="sd">        inplace : bool</span>
<span class="sd">            If False (the default), return a new object containing the</span>
<span class="sd">            convolved array.</span>
<span class="sd">            If True, record the convolved array in self and return self.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `~mpdaf.obj.DataArray`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">inplace</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;The other array must have the same rank as self&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;The other array must be no larger than self&#39;</span><span class="p">)</span>

        <span class="n">kernel</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DataArray</span><span class="p">)</span> <span class="k">else</span> <span class="n">other</span>

        <span class="c1"># Replace any masked pixels in the convolution kernel with zeros.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Replace any masked pixels in out._data with zeros</span>
        <span class="n">masked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">masked</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">out</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">sum</span><span class="p">()):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">out</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">_data</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Are there any variances to be propagated?</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Replace any masked pixels in out._var with zeros</span>
            <span class="k">if</span> <span class="n">masked</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">_var</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">out</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">_var</span><span class="o">.</span><span class="n">sum</span><span class="p">()):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">_var</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">_var</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">out</span><span class="o">.</span><span class="n">_var</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">_var</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Calling the external function now</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">_var</span> <span class="o">=</span> <span class="n">cube_convolve</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span>
                                            <span class="n">variance</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">_var</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="n">fft</span><span class="p">)</span>
        <span class="c1"># Put back nan in the data and var</span>
        <span class="k">if</span> <span class="n">masked</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">out</span><span class="o">.</span><span class="n">_var</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="MuseCube.convolve_cube_to_psf"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.convolve_cube_to_psf">[docs]</a>    <span class="k">def</span> <span class="nf">convolve_cube_to_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_fwhm</span><span class="p">,</span> <span class="n">target_nmoffat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">target_function</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
                             <span class="n">outcube_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">outcube_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">factor_fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                             <span class="n">fft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">erode_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">npixels_erosion</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convolve the cube for a target function &#39;gaussian&#39; or &#39;moffat&#39;</span>

<span class="sd">        Args:</span>
<span class="sd">            target_fwhm (float): target FWHM in arcsecond</span>
<span class="sd">            target_nmoffat: target n if Moffat function</span>
<span class="sd">            target_function (str): &#39;gaussian&#39; or &#39;moffat&#39; [&#39;gaussian&#39;]</span>
<span class="sd">            factor_fwhm (float): number of FWHM for size of Kernel</span>
<span class="sd">            fft (bool): use FFT to convolve or not [False]</span>
<span class="sd">            perslice (bool): doing it per slice, or not [True]</span>
<span class="sd">                If doing it per slice, using a direct astropy fft. If</span>
<span class="sd">                doing it with the cube, it uses much more memory but is</span>
<span class="sd">                more efficient as the convolution is done via mpdaf directly.</span>

<span class="sd">        Creates:</span>
<span class="sd">            Folder and convolved cube names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Separate folder and name of file</span>
        <span class="n">cube_folder</span><span class="p">,</span> <span class="n">cube_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outcube_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outcube_folder</span> <span class="o">=</span> <span class="n">cube_folder</span>

        <span class="c1"># Creating the outcube filename</span>
        <span class="k">if</span> <span class="n">outcube_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outcube_name</span> <span class="o">=</span> <span class="s2">&quot;conv</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1:.2f}{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_function</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">target_fwhm</span><span class="p">,</span> <span class="n">cube_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">outcube_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">outcube_name</span><span class="p">)</span>
        <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The new cube will be named: </span><span class="si">{</span><span class="n">outcube_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Products will be written in </span><span class="si">{</span><span class="n">outcube_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Getting the shape of the Kernel</span>
        <span class="n">scale_spaxel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step</span><span class="p">(</span><span class="n">unit_wcs</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nspaxel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">factor_fwhm</span> <span class="o">*</span> <span class="n">target_fwhm</span> <span class="o">/</span> <span class="n">scale_spaxel</span><span class="p">)</span>
        <span class="c1"># Make nspaxel odd to have a PSF centred at the centre of the frame</span>
        <span class="k">if</span> <span class="n">nspaxel</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nspaxel</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nspaxel</span><span class="p">,</span> <span class="n">nspaxel</span><span class="p">]</span>

        <span class="c1"># Computing the kernel</span>
        <span class="n">kernel3d</span> <span class="o">=</span> <span class="n">cube_kernel</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="o">.</span><span class="n">coord</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">fwhm0</span><span class="p">,</span>
                               <span class="n">target_fwhm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">function</span><span class="p">,</span> <span class="n">target_function</span><span class="p">,</span>
                               <span class="n">lambda0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">l0</span><span class="p">,</span>
                               <span class="n">input_nmoffat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">nmoffat</span><span class="p">,</span>
                               <span class="n">target_nmoffat</span><span class="o">=</span><span class="n">target_nmoffat</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                               <span class="n">scale</span><span class="o">=</span><span class="n">scale_spaxel</span><span class="p">,</span> <span class="n">compute_kernel</span><span class="o">=</span><span class="s1">&#39;pypher&#39;</span><span class="p">)</span>

        <span class="c1"># Calling the local method using astropy convolution</span>
        <span class="n">conv_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astropy_convolve</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">kernel3d</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="n">fft</span><span class="p">)</span>
        <span class="c1"># Copying the unit from the original to the convolved cube</span>
        <span class="n">conv_cube</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

        <span class="c1"># Erode by npixels in case erode is True</span>
        <span class="k">if</span> <span class="n">erode_edges</span><span class="p">:</span>
            <span class="n">nmask</span> <span class="o">=</span> <span class="o">~</span><span class="n">ndi</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">conv_cube</span><span class="o">.</span><span class="n">_data</span><span class="p">),</span> 
                                        <span class="n">mask</span><span class="o">=~</span><span class="n">conv_cube</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span> 
                                        <span class="n">iterations</span><span class="o">=</span><span class="n">npixels_erosion</span><span class="p">)</span>
            <span class="n">conv_cube</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">nmask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="n">conv_cube</span><span class="o">.</span><span class="n">_var</span><span class="p">[</span><span class="n">nmask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="n">conv_cube</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">nmask</span>

        <span class="c1"># Write the output</span>
        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Writing up the derived cube&quot;</span><span class="p">)</span>
        <span class="n">conv_cube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">outcube_folder</span><span class="p">,</span> <span class="n">outcube_name</span><span class="p">))</span>

        <span class="c1"># Write the kernel3D</span>
        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Writing up the used kernel&quot;</span><span class="p">)</span>
        <span class="n">kercube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">kernel3d</span><span class="p">)</span>
        <span class="n">kercube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">outcube_folder</span><span class="p">,</span> <span class="s2">&quot;ker3d_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outcube_name</span><span class="p">)))</span>

        <span class="c1"># just provide the output name by folder+name</span>
        <span class="k">return</span> <span class="n">outcube_folder</span><span class="p">,</span> <span class="n">outcube_name</span></div>

<div class="viewcode-block" id="MuseCube.create_reference_cube"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.create_reference_cube">[docs]</a>    <span class="k">def</span> <span class="nf">create_reference_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambdamin</span><span class="o">=</span><span class="mi">4700</span><span class="p">,</span> <span class="n">lambdamax</span><span class="o">=</span><span class="mi">9400</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">outcube_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_for_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a reference cube using an input one, and overiding</span>
<span class="sd">        the lambda part, to get a new WCS</span>

<span class="sd">        Args:</span>
<span class="sd">            lambdamin:</span>
<span class="sd">            lambdamax:</span>
<span class="sd">            step:</span>
<span class="sd">            outcube_name:</span>
<span class="sd">            filter_for_nan:</span>
<span class="sd">            **kwargs:</span>

<span class="sd">        Returns:</span>
<span class="sd">            cube_folder, outcube_name (str, str): the name of the folder where</span>
<span class="sd">               the output cube is, and its name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Separate folder and name of file</span>
        <span class="n">cube_folder</span><span class="p">,</span> <span class="n">cube_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Creating the outcube filename</span>
        <span class="k">if</span> <span class="n">outcube_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;l</span><span class="si">{0:4d}</span><span class="s2">l</span><span class="si">{1:4d}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">lambdamin</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">lambdamax</span><span class="p">)))</span>
            <span class="n">outcube_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">cube_name</span><span class="p">)</span>

        <span class="c1"># Range of lambd and number of spectral pixels</span>
        <span class="n">range_lambda</span> <span class="o">=</span> <span class="n">lambdamax</span> <span class="o">-</span> <span class="n">lambdamin</span>
        <span class="n">npix_spec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">range_lambda</span> <span class="o">//</span> <span class="n">step</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># if filter_nan remove the Nan</span>
        <span class="k">if</span> <span class="n">filter_for_nan</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">selgood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="n">print_debug</span><span class="p">(</span><span class="s2">&quot;Xmin=</span><span class="si">{0}</span><span class="s2"> Xmax=</span><span class="si">{1}</span><span class="s2"> / Ymin=</span><span class="si">{2}</span><span class="s2"> Ymax=</span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">selgood</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">selgood</span><span class="p">]),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">selgood</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">selgood</span><span class="p">])))</span>
            <span class="n">subcube</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">selgood</span><span class="p">]):</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">selgood</span><span class="p">]),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">selgood</span><span class="p">]):</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">selgood</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subcube</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Create the WCS which we need for the output cube</span>
        <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">subcube</span><span class="o">.</span><span class="n">get_wcs_header</span><span class="p">()</span>
        <span class="n">wcs1</span> <span class="o">=</span> <span class="n">subcube</span><span class="o">.</span><span class="n">wcs</span>
        <span class="n">wave1</span> <span class="o">=</span> <span class="n">WaveCoord</span><span class="p">(</span><span class="n">cdelt</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">crval</span><span class="o">=</span><span class="n">lambdamin</span><span class="p">,</span> 
                <span class="n">ctype</span><span class="o">=</span><span class="n">wcs_header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">],</span> <span class="n">crpix</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">npix_spec</span><span class="p">)</span>
        <span class="c1"># Create a fake dataset with int to be faster</span>
        <span class="n">cube_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npix_spec</span><span class="p">,</span> <span class="n">wcs1</span><span class="o">.</span><span class="n">naxis2</span><span class="p">,</span> <span class="n">wcs1</span><span class="o">.</span><span class="n">naxis1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">Cube</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cube_data</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">wcs1</span><span class="p">,</span> <span class="n">wave</span><span class="o">=</span><span class="n">wave1</span><span class="p">)</span>
        <span class="c1"># Write the output</span>
        <span class="n">cube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">cube_folder</span><span class="p">,</span> <span class="n">outcube_name</span><span class="p">))</span>

        <span class="c1"># just provide the output name by folder+name</span>
        <span class="k">return</span> <span class="n">cube_folder</span><span class="p">,</span> <span class="n">outcube_name</span></div>

<div class="viewcode-block" id="MuseCube.get_set_spectra"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.get_set_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">get_set_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a set of standard spectra from the Cube</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_fullgalaxy</span> <span class="o">=</span> <span class="n">MuseSpectrum</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Full galaxy Spectrum&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_4quad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quadrant_spectra_from_cube</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_central_aper</span> <span class="o">=</span> <span class="n">MuseSetSpectra</span><span class="p">(</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">get_spectrum_from_cube</span><span class="p">(</span><span class="n">pixel_window</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Central aperture&quot;</span><span class="p">),</span> 
               <span class="bp">self</span><span class="o">.</span><span class="n">get_spectrum_from_cube</span><span class="p">(</span><span class="n">pixel_window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Central Aperture, w=20&quot;</span><span class="p">),</span> 
               <span class="bp">self</span><span class="o">.</span><span class="n">get_spectrum_from_cube</span><span class="p">(</span><span class="n">pixel_window</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Central Aperture, w=40&quot;</span><span class="p">),</span>
               <span class="n">subtitle</span><span class="o">=</span><span class="s2">&quot;central_spectra&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseCube.get_quadrant_spectra_from_cube"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.get_quadrant_spectra_from_cube">[docs]</a>    <span class="k">def</span> <span class="nf">get_quadrant_spectra_from_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_window</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get quadrant spectra from the Cube</span>

<span class="sd">        Input</span>
<span class="sd">        ----</span>
<span class="sd">        pixel_window : pixel_window of integration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ny4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="n">nx4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="n">nx34</span><span class="p">,</span> <span class="n">ny34</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">nx4</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ny4</span>

        <span class="n">spec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectrum_from_cube</span><span class="p">(</span> <span class="n">nx4</span><span class="p">,</span>  <span class="n">ny4</span><span class="p">,</span> <span class="n">pixel_window</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Quadrant 1&quot;</span><span class="p">)</span>
        <span class="n">spec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectrum_from_cube</span><span class="p">(</span> <span class="n">nx4</span><span class="p">,</span> <span class="n">ny34</span><span class="p">,</span> <span class="n">pixel_window</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Quadrant 2&quot;</span><span class="p">)</span> 
        <span class="n">spec3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectrum_from_cube</span><span class="p">(</span><span class="n">nx34</span><span class="p">,</span>  <span class="n">ny4</span><span class="p">,</span> <span class="n">pixel_window</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Quadrant 3&quot;</span><span class="p">)</span> 
        <span class="n">spec4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectrum_from_cube</span><span class="p">(</span><span class="n">nx34</span><span class="p">,</span> <span class="n">ny34</span><span class="p">,</span> <span class="n">pixel_window</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Quadrant 4&quot;</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">MuseSetSpectra</span><span class="p">(</span><span class="n">spec1</span><span class="p">,</span> <span class="n">spec2</span><span class="p">,</span> <span class="n">spec3</span><span class="p">,</span> <span class="n">spec4</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="s2">&quot;4 Quadrants&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseCube.get_emissionline_image"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.get_emissionline_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_emissionline_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">redshift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lambda_window</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="s1">&#39;vacuum&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a narrow band image around Ha</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        lambda_window: in Angstroems (10 by default). Width of the window of integration</span>
<span class="sd">        medium: vacuum or air (string, &#39;vacuum&#39; by default)</span>
<span class="sd">        velocity: default is 0. (km/s)</span>
<span class="sd">        redshift: default is None. Overwrite velocity if provided.</span>
<span class="sd">        line: name of the emission line (see emission_lines dictionary)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">[</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_emissionline_band</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">velocity</span><span class="p">,</span>
                <span class="n">redshift</span><span class="o">=</span><span class="n">redshift</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="n">medium</span><span class="p">,</span> <span class="n">lambda_window</span><span class="o">=</span><span class="n">lambda_window</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">MuseImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_lambda</span><span class="p">(</span><span class="n">lmin</span><span class="p">,</span> <span class="n">lmax</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> 
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> map&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseCube.build_filterlist_images"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.build_filterlist_images">[docs]</a>    <span class="k">def</span> <span class="nf">build_filterlist_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_list</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;IMAGE_FOV&quot;</span><span class="p">,</span>
                              <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            filter_list:</span>
<span class="sd">            prefix:</span>
<span class="sd">            suffix:</span>
<span class="sd">            folder:</span>
<span class="sd">            **kwargs:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Building images for each filter in given list&quot;</span><span class="p">)</span>
        <span class="n">cube_folder</span><span class="p">,</span> <span class="n">cube_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">cube_folder</span>

        <span class="n">suffix</span> <span class="o">=</span> <span class="n">add_string</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

        <span class="n">filter_list</span> <span class="o">=</span> <span class="n">check_filter_list</span><span class="p">(</span><span class="n">filter_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filtername</span> <span class="ow">in</span> <span class="n">filter_list</span><span class="p">:</span>
            <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filter = </span><span class="si">{</span><span class="n">filtername</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ima</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filter_image</span><span class="p">(</span><span class="n">filter_name</span><span class="o">=</span><span class="n">filtername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ima</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">print_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not reconstruct Image with Filter </span><span class="si">{</span><span class="n">filtername</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">ima_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">filtername</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.fits&quot;</span>
            <span class="n">print_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing image </span><span class="si">{</span><span class="n">ima_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ima</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">ima_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="MuseCube.get_filter_image"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.get_filter_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_filter_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">own_filter_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_folder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">dict_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an image given by a filter. If the filter belongs to</span>
<span class="sd">        the filter list, then use that, otherwise use the given file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Building Image with MUSE &quot;</span>
                             <span class="s2">&quot;filter </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filter_name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">filter_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;white&quot;</span><span class="p">:</span>
                <span class="c1"># filter_wave = np.array([4000.,5000.,6000.,7000.,</span>
                <span class="c1">#                         8000.,9000.,10000.])</span>
                <span class="c1"># filter_sensitivity = np.ones_like(filter_wave)</span>
                <span class="c1"># refimage = self.bandpass_image(filter_wave, filter_sensitivity,</span>
                <span class="c1">#                            interpolation=&#39;linear&#39;)</span>
                <span class="n">refimage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">refimage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_band_image</span><span class="p">(</span><span class="n">filter_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># initialise the filter file</span>
            <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Reading private reference filter </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filter_name</span><span class="p">))</span>

            <span class="c1"># First we check the extra dictionary if provided</span>
            <span class="k">if</span> <span class="n">dict_filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filter_name</span> <span class="ow">in</span> <span class="n">dict_filters</span><span class="p">:</span>
                    <span class="n">filter_file</span> <span class="o">=</span> <span class="n">dict_filters</span><span class="p">[</span><span class="n">filter_name</span><span class="p">]</span>
            <span class="c1"># then we check the package internal filter list</span>
            <span class="k">elif</span> <span class="n">filter_name</span> <span class="ow">in</span> <span class="n">dict_extra_filters</span><span class="p">:</span>
                <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Found filter in pymusepipe internal dictionary &quot;</span>
                                 <span class="s2">&quot;(see data/Filters)&quot;</span><span class="p">)</span>
                <span class="n">filter_folder</span> <span class="o">=</span> <span class="n">pymusepipe</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">filter_file</span> <span class="o">=</span> <span class="n">dict_extra_filters</span><span class="p">[</span><span class="n">filter_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;[mpdaf_pipe / get_filter_image] &quot;</span>
                                  <span class="s2">&quot;Filter name not in private dictionary - Aborting&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">own_filter_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;[mpdaf_pipe / get_filter_image] &quot;</span>
                                      <span class="s2">&quot;No extra filter dictionary and &quot;</span>
                                      <span class="s2">&quot;the private filter file is not set - Aborting&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filter_file</span> <span class="o">=</span> <span class="n">own_filter_file</span>
            <span class="c1"># Now reading the filter data</span>
            <span class="n">path_filter</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">filter_folder</span><span class="p">,</span> <span class="n">filter_file</span><span class="p">)</span>
            <span class="n">filter_wave</span><span class="p">,</span> <span class="n">filter_sensitivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path_filter</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Building Image with filter </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filter_name</span><span class="p">))</span>
            <span class="c1"># using mpdaf bandpass_image to build the image</span>
            <span class="n">refimage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandpass_image</span><span class="p">(</span><span class="n">filter_wave</span><span class="p">,</span> <span class="n">filter_sensitivity</span><span class="p">,</span>
                                           <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>

            <span class="c1"># Adding FILTER NAME to the primary header</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;HIERARCH ESO DRS MUSE FILTER NAME&#39;</span>
            <span class="n">refimage</span><span class="o">.</span><span class="n">primary_header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">filter_name</span><span class="p">,</span> <span class="s1">&#39;filter name used&#39;</span><span class="p">)</span>

            <span class="c1"># Copying the unit from the cube</span>
            <span class="n">refimage</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

            <span class="n">add_mpdaf_method_keywords</span><span class="p">(</span><span class="n">refimage</span><span class="o">.</span><span class="n">primary_header</span><span class="p">,</span> 
                    <span class="s2">&quot;cube.bandpass_image&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> 
                    <span class="p">[</span><span class="n">filter_name</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;filter name used&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">refimage</span></div>

<div class="viewcode-block" id="MuseCube.mask_trail"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.mask_trail">[docs]</a>    <span class="k">def</span> <span class="nf">mask_trail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pq1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pq2</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                   <span class="n">margins</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a cube mask from 2 points measured from a trail on an image</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        pq1: array or tuple (float)</span>
<span class="sd">            p and q coordinates of point 1 along the trail</span>
<span class="sd">        pq2: array or tuple (float)</span>
<span class="sd">            p and q coordinates of point 2 along the trail</span>
<span class="sd">        width: float</span>
<span class="sd">            Value (in pixel) of the full slit width to exclude</span>
<span class="sd">        margins: float</span>
<span class="sd">            Value (in pixel) to extend the slit beyond the 2 extrema</span>
<span class="sd">            If 0, this means limiting it to the extrema themselves.</span>
<span class="sd">            Default is None, which mean infinitely long slit</span>
<span class="sd">        reset (bool): if True, reset the mask before masking the slit</span>
<span class="sd">        save (bool): if True, save the masked cube</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If width = 0 just don&#39;t do anything</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Trail width is 0, hence no doing anything&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.</span>

        <span class="c1"># Calculating the coordinates of the p and q&#39;s</span>
        <span class="c1"># X2 - X1 -&gt; note that X is q, hence the second value</span>
        <span class="c1"># Y2 - Y1 -&gt; note that Y is p, hence the first value</span>
        <span class="n">pq1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pq1</span><span class="p">)</span>
        <span class="n">pq2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pq2</span><span class="p">)</span>
        <span class="n">vect</span> <span class="o">=</span> <span class="n">pq2</span> <span class="o">-</span> <span class="n">pq1</span>
        <span class="n">nvect</span> <span class="o">=</span> <span class="n">vect</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">vect</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vect</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ovect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nvect</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">nvect</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="c1"># New corners depending on width and margins</span>
        <span class="n">corner1</span> <span class="o">=</span> <span class="n">pq1</span> <span class="o">-</span> <span class="n">margins</span> <span class="o">*</span> <span class="n">nvect</span> <span class="o">+</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">ovect</span>
        <span class="n">corner2</span> <span class="o">=</span> <span class="n">pq1</span> <span class="o">-</span> <span class="n">margins</span> <span class="o">*</span> <span class="n">nvect</span> <span class="o">-</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">ovect</span>
        <span class="n">corner3</span> <span class="o">=</span> <span class="n">pq2</span> <span class="o">+</span> <span class="n">margins</span> <span class="o">*</span> <span class="n">nvect</span> <span class="o">-</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">ovect</span>
        <span class="n">corner4</span> <span class="o">=</span> <span class="n">pq2</span> <span class="o">+</span> <span class="n">margins</span> <span class="o">*</span> <span class="n">nvect</span> <span class="o">+</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">ovect</span>
        <span class="c1"># This is the new tuple to feed mask_polygon</span>
        <span class="n">pol</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">corner1</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">corner2</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">corner3</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">corner4</span><span class="p">)]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Reset mask if requested</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">unmask</span><span class="p">()</span>

        <span class="n">out</span><span class="o">.</span><span class="n">mask_polygon</span><span class="p">(</span><span class="n">pol</span><span class="p">,</span> <span class="n">unit_poly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inside</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">out</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Rewrite a new cube</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;tmask&quot;</span><span class="p">)</span>
            <span class="n">use_folder</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;use_folder&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="n">cube_folder</span><span class="p">,</span> <span class="n">cube_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">trailcube_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">cube_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">use_folder</span><span class="p">:</span>
                <span class="n">trailcube_name</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">cube_folder</span><span class="p">,</span> <span class="n">trailcube_name</span><span class="p">)</span>

            <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Writing the new Cube </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trailcube_name</span><span class="p">))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">trailcube_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseCube.save_mask"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseCube.save_mask">[docs]</a>    <span class="k">def</span> <span class="nf">save_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_name</span><span class="o">=</span><span class="s2">&quot;dummy_mask.fits&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the mask into a 0-1 image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newimage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mask_name</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MuseSkyContinuum"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseSkyContinuum">[docs]</a><span class="k">class</span> <span class="nc">MuseSkyContinuum</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<div class="viewcode-block" id="MuseSkyContinuum.read"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseSkyContinuum.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read sky continuum spectrum from MUSE data reduction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
            <span class="n">crval</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cdelt</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sky</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">crval</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[</span><span class="s1">&#39;lambda&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cdelt</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[</span><span class="s1">&#39;lambda&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">crval</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
        <span class="n">wavein</span> <span class="o">=</span> <span class="n">WaveCoord</span><span class="p">(</span><span class="n">cdelt</span><span class="o">=</span><span class="n">cdelt</span><span class="p">,</span> <span class="n">crval</span><span class="o">=</span><span class="n">crval</span><span class="p">,</span> <span class="n">cunit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">Spectrum</span><span class="p">(</span><span class="n">wave</span><span class="o">=</span><span class="n">wavein</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSkyContinuum.integrate"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseSkyContinuum.integrate">[docs]</a>    <span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">muse_filter</span><span class="p">,</span> <span class="n">ao_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Integrate a sky continuum spectrum using a certain filter file.</span>
<span class="sd">        If the file is a fits file, use it as the MUSE filter list.</span>
<span class="sd">        Otherwise use it as an ascii file</span>
<span class="sd">    </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        muse_filter: MuseFilter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># interpolation linearly the filter throughput onto</span>
        <span class="c1"># the spectrum wavelength</span>
        <span class="n">muse_filter</span><span class="o">.</span><span class="n">flux_cont</span> <span class="o">=</span> <span class="n">integrate_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span> 
                                                   <span class="n">muse_filter</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> 
                                                   <span class="n">muse_filter</span><span class="o">.</span><span class="n">throughput</span><span class="p">,</span>
                                                   <span class="n">ao_mask</span><span class="o">=</span><span class="n">ao_mask</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">muse_filter</span><span class="o">.</span><span class="n">filter_name</span><span class="p">,</span> <span class="n">muse_filter</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSkyContinuum.set_normfactor"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseSkyContinuum.set_normfactor">[docs]</a>    <span class="k">def</span> <span class="nf">set_normfactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="s2">&quot;Cousins_R&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the normalisation factor given a background value</span>
<span class="sd">        Takes the background value and the sky continuuum spectrum</span>
<span class="sd">        and convert this to the scaling Ks needed for this sky continuum</span>
<span class="sd">        The principle relies on having the background measured as:</span>
<span class="sd">        MUSE_calib = ((MUSE - Sky_cont) + Background) * Norm</span>

<span class="sd">        as measured from the alignment procedure.</span>

<span class="sd">        Since we want:</span>
<span class="sd">        MUSE_calib = ((MUSE - Ks * Sky_cont) + 0) * Norm</span>

<span class="sd">        This means that: Ks * Sky_cont = Sky_cont - Background</span>
<span class="sd">        ==&gt; Ks = 1 - Background / Sky_cont</span>

<span class="sd">        So we integrate the Sky_cont to get the corresponding S value</span>
<span class="sd">        and then provide Ks as 1-B/S</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        background: float</span>
<span class="sd">            Value of the background to consider</span>
<span class="sd">        filter_name: str</span>
<span class="sd">            Name of the filter to consider</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">):</span>
            <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;No integration value for filter </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                  <span class="n">filter_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">muse_filter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">muse_filter</span><span class="o">.</span><span class="n">flux_cont</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">background</span> <span class="o">/</span> <span class="n">muse_filter</span><span class="o">.</span><span class="n">flux_cont</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="mf">1.</span>

            <span class="c1"># Saving the norm value for that filter</span>
            <span class="n">muse_filter</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span>
            <span class="n">muse_filter</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">background</span></div>

<div class="viewcode-block" id="MuseSkyContinuum.save_normalised"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseSkyContinuum.save_normalised">[docs]</a>    <span class="k">def</span> <span class="nf">save_normalised</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalises a sky continuum spectrum and save it</span>
<span class="sd">        within a new fits file</span>
<span class="sd">    </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        norm_factor: float</span>
<span class="sd">            Scale factor to multiply the input continuum</span>
<span class="sd">        prefix: str</span>
<span class="sd">            Prefix for the new continuum fits name. Default</span>
<span class="sd">            is &#39;norm&#39;, so that the new file is &#39;norm_oldname.fits&#39;</span>
<span class="sd">        overwrite: bool</span>
<span class="sd">            If True, existing file will be overwritten.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;[mpdaf_pipe / save_normalised] The new and old sky &quot;</span>
                              <span class="s2">&quot;continuum fits files will share the same name&quot;</span><span class="p">)</span>
            <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;This is not recommended - Aborting&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    
        <span class="n">folder_spec</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">newfilename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">norm_filename</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">folder_spec</span><span class="p">,</span> <span class="n">newfilename</span><span class="p">)</span>
    
        <span class="c1"># Opening the fits file</span>
        <span class="n">skycont</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
    
        <span class="c1"># getting the data</span>
        <span class="n">dcont</span> <span class="o">=</span> <span class="n">skycont</span><span class="p">[</span><span class="s1">&#39;CONTINUUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    
        <span class="c1"># Create new continuum</span>
        <span class="c1"># ------------------------------</span>
        <span class="n">new_cont</span> <span class="o">=</span> <span class="n">dcont</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm_factor</span>
        <span class="n">skycont</span><span class="p">[</span><span class="s1">&#39;CONTINUUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cont</span>
    
        <span class="c1"># Writing to the new file</span>
        <span class="n">skycont</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">norm_filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="n">print_info</span><span class="p">(</span><span class="s1">&#39;Normalised Factor used = </span><span class="si">{0:8.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">norm_factor</span><span class="p">))</span>
        <span class="n">print_info</span><span class="p">(</span><span class="s1">&#39;Normalised Sky Continuum </span><span class="si">{}</span><span class="s1"> has been created&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">norm_filename</span><span class="p">))</span></div></div>

<span class="c1"># Routine to read filters</span>
<div class="viewcode-block" id="MuseFilter"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseFilter">[docs]</a><span class="k">class</span> <span class="nc">MuseFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="s2">&quot;Cousins_R&quot;</span><span class="p">,</span> <span class="n">filter_fits_file</span><span class="o">=</span><span class="s2">&quot;filter_list.fits&quot;</span><span class="p">,</span>
                 <span class="n">filter_ascii_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Routine to read the throughput of a filter</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        filter_name: str</span>
<span class="sd">            Name of the filter, required if filter_file is a fits file.</span>
<span class="sd">        filter_fits_file: str</span>
<span class="sd">            Name of the fits file for the filter list</span>
<span class="sd">        filter_ascii_file: str</span>
<span class="sd">            Name of the ascii file with the lambda, throughout values</span>
<span class="sd">            By default, it is None and ignored. If not, this is taken</span>
<span class="sd">            as the input for the filter throughput</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_fits_file</span> <span class="o">=</span> <span class="n">filter_fits_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span> <span class="o">=</span> <span class="n">filter_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_ascii_file</span> <span class="o">=</span> <span class="n">filter_ascii_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<div class="viewcode-block" id="MuseFilter.read"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseFilter.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reading the data in the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_ascii_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Using the fits file </span><span class="si">{0}</span><span class="s2"> as input&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_fits_file</span><span class="p">))</span>
                <span class="n">filter_data</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_fits_file</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">=</span> <span class="n">filter_data</span><span class="p">[</span><span class="s1">&#39;lambda&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="n">filter_data</span><span class="p">[</span><span class="s1">&#39;throughput&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Problem opening the filter fits file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_fits_file</span><span class="p">))</span>
                <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Did not manage to get the filter </span><span class="si">{0}</span><span class="s2"> throughput&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Using the ascii file </span><span class="si">{0}</span><span class="s2"> as input&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_ascii_file</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_ascii_file</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="MuseImage"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseImage">[docs]</a><span class="k">class</span> <span class="nc">MuseImage</span><span class="p">(</span><span class="n">Image</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;Wrapper around the mpdaf Image functionalities</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialisation of the opening of an Image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Arguments for the plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s2">&quot;Frame&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;vmin&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorbar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;colorbar&#39;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">Image</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
 
        <span class="bp">self</span><span class="o">.</span><span class="n">get_fwhm_startend</span><span class="p">()</span>

<div class="viewcode-block" id="MuseImage.get_fwhm_startend"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseImage.get_fwhm_startend">[docs]</a>    <span class="k">def</span> <span class="nf">get_fwhm_startend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get range of FWHM</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_startobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_header</span><span class="p">[</span><span class="s1">&#39;HIERARCH ESO TEL AMBI FWHM START&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_endobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_header</span><span class="p">[</span><span class="s1">&#39;HIERARCH ESO TEL AMBI FWHM END&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="MuseImage.mask_trail"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseImage.mask_trail">[docs]</a>    <span class="k">def</span> <span class="nf">mask_trail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pq1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">pq2</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build an image mask from 2 points measured from a trail</span>
<span class="sd">    </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        pq1: array or tuple (float)</span>
<span class="sd">            p and q coordinates of point 1 along the trail</span>
<span class="sd">        pq2: array or tuple (float) </span>
<span class="sd">            p and q coordinates of point 2 along the trail</span>
<span class="sd">        width: float</span>
<span class="sd">            Value (in pixel) of the full slit width to exclude</span>
<span class="sd">        extent: float</span>
<span class="sd">            Value (in pixel) to extend the slit beyond the 2 extrema</span>
<span class="sd">            If 0, this means limiting it to the extrema themselves.</span>
<span class="sd">            Default is None, which mean infinitely long slit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If width = 0 just don&#39;t do anything</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Trail width is 0, hence no doing anything&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Create an index grid using the Image shape</span>
        <span class="c1"># Note that p is the Y axis, while q is the X axis</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># X2 - X1 -&gt; note that X is q, hence the second value</span>
        <span class="c1"># Y2 - Y1 -&gt; note that Y is p, hence the first value</span>
        <span class="n">y21</span><span class="p">,</span> <span class="n">x21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pq2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pq1</span><span class="p">)</span>

        <span class="c1"># Mask based on the distance to the line defined by the 2 points</span>
        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y21</span> <span class="o">*</span> <span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pq1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">x21</span> <span class="o">*</span> <span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pq1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> \
                       <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x21</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y21</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="c1"># Mask based on the extent of the slit</span>
        <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y01</span><span class="p">,</span> <span class="n">x01</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pq1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pq1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">angle21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y01</span><span class="p">,</span> <span class="n">x01</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y21</span><span class="p">,</span> <span class="n">x21</span><span class="p">)</span>
            <span class="n">xcoord1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">x01</span><span class="p">,</span> <span class="n">y01</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle21</span><span class="p">)</span>
            <span class="n">ext_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">xcoord1</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">extent</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xcoord1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">x21</span><span class="p">,</span> <span class="n">y21</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">extent</span><span class="p">)</span>  
            <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask_image</span> <span class="o">&amp;</span> <span class="n">ext_mask</span>

        <span class="c1"># Reset mask if requested</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_mask</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">mask_image</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="MuseImage.reset_mask"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseImage.reset_mask">[docs]</a>    <span class="k">def</span> <span class="nf">reset_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resetting the Image mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># just resetting the mask of the image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MuseImage.save_mask"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseImage.save_mask">[docs]</a>    <span class="k">def</span> <span class="nf">save_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_name</span><span class="o">=</span><span class="s2">&quot;dummy_mask.fits&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the mask into a 0-1 image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newimage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mask_name</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="MuseSetImages"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseSetImages">[docs]</a><span class="k">class</span> <span class="nc">MuseSetImages</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Set of images</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MuseSetImages</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="nb">list</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">list</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="MuseSetImages.update"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseSetImages.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># 1 required attribute</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;subtitle&#39;</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;subtitle&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="p">:</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Overiding subtitle&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subtitle&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="MuseSpectrum"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseSpectrum">[docs]</a><span class="k">class</span> <span class="nc">MuseSpectrum</span><span class="p">(</span><span class="n">Spectrum</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;Wrapper around the mpdaf Spectrum functionalities</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialisation of the opening of spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Arguments for the plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s2">&quot;Spectrum&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_sky_lines</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;add_sky_lines&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_sky_lines</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color_sky</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;color_sky&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linestyle_sky</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;linestyle_sky&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_sky</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;alpha_sky&quot;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">Spectrum</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MuseSetSpectra"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseSetSpectra">[docs]</a><span class="k">class</span> <span class="nc">MuseSetSpectra</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Set of spectra</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MuseSetSpectra</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="nb">list</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">list</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="MuseSetSpectra.update"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.MuseSetSpectra.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1">## 1 required attribute</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;subtitle&#39;</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;subtitle&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="p">:</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Overiding subtitle&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subtitle&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="PixTableToMask"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.PixTableToMask">[docs]</a><span class="k">class</span> <span class="nc">PixTableToMask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is meant to just be a simple tool to</span>
<span class="sd">    mask out some regions from the PixTable using Image masks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixtable_name</span><span class="p">,</span> <span class="n">image_name</span><span class="p">,</span> <span class="n">suffix_out</span><span class="o">=</span><span class="s2">&quot;tmask&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class made to associate a PixTable and an Image</span>
<span class="sd">        Used to select all pixels from a pixtable outside the trail </span>
<span class="sd">        defined by the trail mask of an image</span>
<span class="sd">        Then flushes the pixtable into a new one.</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        pixtable_name: str</span>
<span class="sd">            Name of the Pixel Table</span>
<span class="sd">        image_name: str</span>
<span class="sd">            Name of Image which should include a mask</span>
<span class="sd">        suffix_out: str</span>
<span class="sd">            Suffix to be used for the new PixTable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix_out</span> <span class="o">=</span> <span class="n">suffix_out</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pixtable_name</span><span class="p">):</span>
            <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Input PixTable does not exist&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">image_name</span><span class="p">):</span>
            <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Input Image does not exist&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_name</span> <span class="o">=</span> <span class="n">image_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixtable_name</span> <span class="o">=</span> <span class="n">pixtable_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pixtable_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixtable_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pixtable_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">MuseImage</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">image_name</span><span class="p">)</span>

<div class="viewcode-block" id="PixTableToMask.imshow"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.PixTableToMask.imshow">[docs]</a>    <span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Just showing the image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="PixTableToMask.create_mask"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.PixTableToMask.create_mask">[docs]</a>    <span class="k">def</span> <span class="nf">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pq1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">pq2</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">mask_name</span><span class="o">=</span><span class="s2">&quot;dummy_mask.fits&quot;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the mask and save it in one go</span>
<span class="sd">   </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        pq1: array or tuple (float)</span>
<span class="sd">            p and q coordinates of point 1 along the trail</span>
<span class="sd">        pq2: array or tuple (float) </span>
<span class="sd">            p and q coordinates of point 2 along the trail</span>
<span class="sd">        width: float</span>
<span class="sd">            Value (in pixel) of the full slit width to exclude</span>
<span class="sd">        reset: bool</span>
<span class="sd">            By default False, so the mask goes on top of the existing one</span>
<span class="sd">            If True, will reset the mask before building it.</span>
<span class="sd">        extent: float</span>
<span class="sd">            Value (in pixel) to extend the slit beyond the 2 extrema</span>
<span class="sd">            If 0, this means limiting it to the extrema themselves.</span>
<span class="sd">            Default is None, which mean infinitely long slit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">mask_trail</span><span class="p">(</span><span class="n">pq1</span><span class="o">=</span><span class="n">pq1</span><span class="p">,</span> <span class="n">pq2</span><span class="o">=</span><span class="n">pq2</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">reset</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_mask</span><span class="p">(</span><span class="n">mask_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="PixTableToMask.save_mask"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.PixTableToMask.save_mask">[docs]</a>    <span class="k">def</span> <span class="nf">save_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_name</span><span class="o">=</span><span class="s2">&quot;dummy_mask.fits&quot;</span><span class="p">,</span> <span class="n">use_folder</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saving the mask from the Image into a fits file</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        mask_name: str</span>
<span class="sd">            Name of the fits file for the mask</span>
<span class="sd">        use_folder: bool</span>
<span class="sd">            If True (default) will look for the mask in the image_folder.</span>
<span class="sd">            If False, will just look for it where the command is run.</span>

<span class="sd">        Creates</span>
<span class="sd">        -------</span>
<span class="sd">        A fits file with the mask as 0 and 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_folder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_name</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_folder</span><span class="p">,</span> <span class="n">mask_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_name</span> <span class="o">=</span> <span class="n">mask_name</span>

        <span class="c1"># Using the image folder to save the mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">save_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="PixTableToMask.mask_pixtable"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.mpdaf_pipe.PixTableToMask.mask_pixtable">[docs]</a>    <span class="k">def</span> <span class="nf">mask_pixtable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the Image Mask and create a new Pixtable</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        mask_name: str</span>
<span class="sd">            Name of the mask to be used (FITS file)</span>
<span class="sd">        use_folder: bool</span>
<span class="sd">            If True, use the same folder as the Pixtable</span>
<span class="sd">            Otherwise just write where you stand</span>
<span class="sd">        suffix_out: str</span>
<span class="sd">            Suffix for the name of the output Pixtable</span>
<span class="sd">            If provided, will overwrite the one in self.suffix_out</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Open the PixTable</span>
        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Opening the Pixtable </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">pixtable_name</span><span class="p">))</span>
        <span class="n">pixtable</span> <span class="o">=</span> <span class="n">PixTable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixtable_name</span><span class="p">)</span>

        <span class="c1"># Use the Image mask and create a pixtable mask</span>
        <span class="k">if</span> <span class="n">mask_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_name</span> <span class="o">=</span> <span class="n">mask_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mask_name&quot;</span><span class="p">):</span>
                <span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Please provide a mask name (FITS file)&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Creating a column Mask from file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">mask_name</span><span class="p">))</span>
        <span class="n">mask_col</span> <span class="o">=</span> <span class="n">pixtable</span><span class="o">.</span><span class="n">mask_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_name</span><span class="p">)</span>

        <span class="c1"># extract the right data using the pixtable mask</span>
        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Extracting the Mask&quot;</span><span class="p">)</span>
        <span class="n">newpixtable</span> <span class="o">=</span> <span class="n">pixtable</span><span class="o">.</span><span class="n">extract_from_mask</span><span class="p">(</span><span class="n">mask_col</span><span class="o">.</span><span class="n">maskcol</span><span class="p">)</span>

        <span class="c1"># Rewrite a new pixtable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix_out</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;suffix_out&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_out</span><span class="p">)</span>
        <span class="n">use_folder</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;use_folder&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_folder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newpixtable_name</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixtable_folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">suffix_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixtable_name</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newpixtable_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixtable_name</span><span class="p">)</span>

        <span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Writing the new PixTable in </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">newpixtable_name</span><span class="p">))</span>
        <span class="n">newpixtable</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newpixtable_name</span><span class="p">)</span>

        <span class="c1"># Now transfer the flat field if it exists</span>
        <span class="n">ext_name</span> <span class="o">=</span> <span class="s1">&#39;PIXTABLE_FLAT_FIELD&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Test if Extension exists by reading header</span>
            <span class="c1"># If it exists then do nothing</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newpixtable_name</span><span class="p">,</span> <span class="n">ext_name</span><span class="p">)</span>
            <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Flat field extension already exists in masked PixTable - all good&quot;</span><span class="p">)</span>
        <span class="c1"># If it does not exist test if it exists in the original PixTable</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Read data and header</span>
                <span class="n">ff_ext_data</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixtable_name</span><span class="p">,</span> <span class="n">ext_name</span><span class="p">)</span>
                <span class="n">ff_ext_h</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixtable_name</span><span class="p">,</span> <span class="n">ext_name</span><span class="p">)</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Flat field extension will be transferred from PixTable&quot;</span><span class="p">)</span>
                <span class="c1"># Append it to the new pixtable</span>
                <span class="n">pyfits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newpixtable_name</span><span class="p">,</span> <span class="n">ff_ext_data</span><span class="p">,</span> <span class="n">ff_ext_h</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;No Flat field extension to transfer - all good&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Patch to fix the extension names of the PixTable</span>
        <span class="c1"># We have to put a number of extension in lowercase to make sure </span>
        <span class="c1"># the MUSE recipes understand them</span>
        <span class="n">descl</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xpos&#39;</span><span class="p">,</span> <span class="s1">&#39;ypos&#39;</span><span class="p">,</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;dq&#39;</span><span class="p">,</span> <span class="s1">&#39;stat&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">descl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pyfits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newpixtable_name</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;EXTNAME&#39;</span><span class="p">,</span> 
                        <span class="n">value</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Rewriting extension name </span><span class="si">{0}</span><span class="s2"> as lowercase&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                       <span class="n">d</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Extension </span><span class="si">{0}</span><span class="s2"> not present - patch ignored&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                       <span class="n">d</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Eric Emsellem.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>